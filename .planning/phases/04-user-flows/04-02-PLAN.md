---
phase: 04-user-flows
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/create/page.tsx
  - app/create/preview/page.tsx
  - app/components/paywall/PaywallModal.tsx
  - backend/app/services/payments.py
autonomous: true

must_haves:
  truths:
    - "User can create route without logging in or paying"
    - "User sees phone simulator with their waypoint's SMS preview"
    - "Paywall modal appears after viewing simulator"
    - "Entry path 'create' is tracked through to Stripe metadata"
    - "After purchase, route is activated and user receives SMS number"
  artifacts:
    - path: "app/create/preview/page.tsx"
      provides: "Simulator preview step before paywall"
      exports: ["default"]
    - path: "app/components/paywall/PaywallModal.tsx"
      provides: "Modal for purchase flow after simulator"
      exports: ["PaywallModal"]
  key_links:
    - from: "app/create/page.tsx"
      to: "app/create/preview/page.tsx"
      via: "router.push after finalize"
      pattern: "router\\.push.*preview"
    - from: "app/create/preview/page.tsx"
      to: "app/components/paywall/PaywallModal.tsx"
      via: "renders PaywallModal on CTA click"
      pattern: "PaywallModal"
    - from: "app/components/paywall/PaywallModal.tsx"
      to: "/api/payments/checkout"
      via: "fetch to create Stripe session"
      pattern: "fetch.*api/payments"
---

<objective>
Implement the "Create First" conversion path (FLOW-02).

Purpose: This is the higher-engagement path where users build investment in their route before paying. User creates route -> sees simulator with their waypoint -> paywall -> purchase -> route activated.

Output:
- Modified route creation flow with preview step
- PhoneSimulator integration showing user's actual waypoint
- PaywallModal component for purchase
- Entry path tracking through to Stripe metadata
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-user-flows/04-RESEARCH.md
@.planning/phases/04-user-flows/04-01-SUMMARY.md

# Existing route creation
@app/create/page.tsx

# SMS format from backend
@backend/app/services/formatter.py (lines 1769-1952 - labeled spaced format)

# Payment patterns
@backend/app/services/payments.py (Stripe metadata)
@app/checkout/page.tsx (checkout form pattern)

# PhoneSimulator from Plan 01
@app/components/simulator/PhoneSimulator.tsx
@app/lib/analytics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add preview step to route creation flow</name>
  <files>app/create/page.tsx, app/create/preview/page.tsx</files>
  <action>
Modify route creation to include a preview step with phone simulator.

1. app/create/page.tsx modifications:
   - After user clicks "Finalize Route" in Step 3:
     - If route has at least 1 waypoint, save route (existing logic)
     - After successful save, redirect to /create/preview?id={routeId}
     - Track 'route_created' analytics event with waypoint count
   - Change "Finalize Route" button text to "Preview SMS Forecast"

2. Create app/create/preview/page.tsx:
   - Load route from URL param ?id=
   - Show PhoneSimulator with first waypoint's SMS preview
   - Generate sample SMS content using labeled spaced format:
     ```
     CAST {smsCode}
     {name} ({elevation}m)
     Light 06:00-20:51

     06h 5-7o Rn15% W12-20 Cld40% CB18 FL22

     08h 7-10o Rn18% W14-22 Cld45% CB17 FL21

     10h 10-14o Rn22% W16-26 Cld52% CB15 FL19

     Rn=Rain W=Wind Cld=Cloud
     CB=CloudBase(x100m) FL=Freeze(x100m)
     ```
   - Below simulator, show route summary: name, waypoint count, list of SMS codes
   - CTA button: "Activate Route - $29.99"
   - Track 'simulator_viewed' analytics event when page loads

3. Layout for preview page:
   - Centered PhoneSimulator (iPhone variant)
   - Route name as heading
   - "This is what you'll receive for {waypointName}" subtitle
   - Waypoint SMS codes list (mini cards)
   - Prominent orange CTA button
   - Small "Edit Route" link back to /create?id=

Note: Use STATIC sample forecast data (not real API call) - research confirmed this is sufficient for MVP.
  </action>
  <verify>
1. Create a route with waypoints
2. Click "Preview SMS Forecast"
3. Verify redirect to /create/preview?id={id}
4. PhoneSimulator shows SMS with waypoint name and code
  </verify>
  <done>
Route creation flows to preview page showing phone simulator with user's waypoint SMS preview.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PaywallModal component</name>
  <files>app/components/paywall/PaywallModal.tsx</files>
  <action>
Create PaywallModal for purchase flow after simulator.

Props interface:
- routeId: number
- routeName: string
- waypointCount: number
- onSuccess: () => void (called after successful purchase)
- onClose: () => void (close modal without purchase)

Modal content:
1. Header: "Activate Your Route"
2. Order summary panel (similar to checkout page):
   - Thunderbird Starter Pack - $29.99
   - Includes $10 SMS credits
   - Route: {routeName} ({waypointCount} waypoints)
   - What's included checkmarks (reuse from checkout page)

3. Form sections (reuse checkout patterns):
   - If NOT logged in: Email, Password, Name fields (create account)
   - If logged in: Show email, just payment
   - Card details: Card number, Expiry, CVC
   - Use same input formatting as checkout page

4. Submit flow:
   - POST to /api/payments/checkout with:
     - email, password, name (if creating account)
     - route_id to activate
     - entry_path from localStorage (getTrackingContext)
   - Show loading spinner during processing
   - On success: call onSuccess, which should redirect to success page
   - On error: show error message inline

5. UI:
   - Modal overlay (dark backdrop)
   - Centered card (max-w-md)
   - Close X button
   - Orange primary button "Pay $29.99"
   - Escape key closes modal
   - Click outside closes modal

Track 'checkout_started' event when modal opens.
  </action>
  <verify>
1. Click "Activate Route" on preview page
2. Modal appears with route details
3. Form validates inputs
4. Submit shows loading state
  </verify>
  <done>
PaywallModal renders with account creation + payment form, tracks checkout_started event.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire preview to paywall and update payment metadata</name>
  <files>app/create/preview/page.tsx, backend/app/services/payments.py</files>
  <action>
Connect preview page to paywall and add entry_path to Stripe metadata.

1. app/create/preview/page.tsx:
   - Add state: showPaywall: boolean (default false)
   - "Activate Route" button onClick: setShowPaywall(true)
   - Render PaywallModal when showPaywall is true
   - onSuccess handler: redirect to /create/success?id={routeId}
   - Create /create/success page showing:
     - Success checkmark
     - "Your route is now active!"
     - Route name and SMS number
     - List of waypoint SMS codes with instructions
     - "Send any code to {smsNumber} to get your forecast"
     - CTA: "View My Routes" -> /routes

2. backend/app/services/payments.py - create_checkout_session():
   - Add entry_path parameter (Optional[str])
   - Add route_id parameter (Optional[int]) for route activation
   - Include in Stripe metadata:
     ```python
     metadata={
         "account_id": str(account_id),
         "order_id": str(order.id),
         "purchase_type": "initial_access",
         "entry_path": entry_path or "unknown",
         "route_id": str(route_id) if route_id else None,
     }
     ```

3. Update payments router to accept these new parameters in the checkout request body.

4. Track 'purchase_completed' event in success page (on mount).
  </action>
  <verify>
1. Complete the create-first flow end-to-end
2. Check Stripe dashboard - checkout session should have entry_path in metadata
3. Success page shows route details and SMS codes
  </verify>
  <done>
Create-first path complete: route creation -> preview with simulator -> paywall -> purchase -> success with SMS codes.
  </done>
</task>

</tasks>

<verification>
End-to-end test of "Create First" path:
1. Visit / or /create
2. Upload GPX or add waypoints manually
3. Click "Preview SMS Forecast"
4. See PhoneSimulator with waypoint SMS preview
5. Click "Activate Route"
6. Complete payment form
7. See success page with SMS codes
8. Verify analytics events logged: route_created, simulator_viewed, checkout_started, purchase_completed
9. Verify Stripe metadata includes entry_path
</verification>

<success_criteria>
- User can create route without logging in
- Preview page shows realistic SMS preview for user's waypoint
- PaywallModal collects account + payment info
- Purchase activates the route
- Entry path tracked through to Stripe metadata
- Analytics events logged at each step
</success_criteria>

<output>
After completion, create `.planning/phases/04-user-flows/04-02-SUMMARY.md` using the standard summary template.
</output>
