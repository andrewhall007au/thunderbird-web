---
phase: 04-user-flows
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/page.tsx
  - app/checkout/page.tsx
  - app/checkout/success/page.tsx
autonomous: true

must_haves:
  truths:
    - "Buy Now button on landing leads to checkout with entry_path='buy'"
    - "Checkout page works for new users (create account + pay)"
    - "After purchase, user is redirected to create route"
    - "Entry path 'buy' is tracked through to Stripe metadata"
  artifacts:
    - path: "app/checkout/success/page.tsx"
      provides: "Success page redirecting to route creation"
      exports: ["default"]
  key_links:
    - from: "app/page.tsx"
      to: "app/checkout/page.tsx"
      via: "Link href with ?path=buy"
      pattern: "href.*checkout.*path=buy"
    - from: "app/checkout/page.tsx"
      to: "/api/payments/checkout"
      via: "fetch POST on form submit"
      pattern: "fetch.*api/payments"
---

<objective>
Implement the "Buy Now" conversion path (FLOW-03).

Purpose: This is the fast path for users ready to purchase immediately. Landing -> Checkout -> Success -> Create Route. Lower friction, captures high-intent users.

Output:
- Updated landing page Buy Now links with path tracking
- Enhanced checkout page with real Stripe integration
- Success page directing to route creation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-user-flows/04-RESEARCH.md
@.planning/phases/04-user-flows/04-01-SUMMARY.md

# Existing pages
@app/page.tsx (landing page with Buy Now buttons)
@app/checkout/page.tsx (mock checkout form)

# Analytics from Plan 01
@app/lib/analytics.ts

# Backend payments
@backend/app/services/payments.py
@backend/app/routers/payments.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update landing page Buy Now links with path tracking</name>
  <files>app/page.tsx</files>
  <action>
Update all Buy Now links on landing page to track entry path.

1. Find all Link components with href="/checkout":
   - Hero section: Buy Now button
   - How It Works section: Buy Now button
   - Features section: Buy Now button
   - Cost Comparison section: Buy Now button
   - CTA section: Buy Now button

2. Update each to: href="/checkout?path=buy"

3. Add analytics initialization to landing page:
   - Import initPathTracking from @/lib/analytics
   - Call in useEffect on mount (with searchParams)
   - This ensures path is tracked even if user lands directly on /

4. Also add "Create Your Route" link in Hero for the create-first path:
   - Add secondary button: "Or Create Your Route First"
   - href="/create?path=create"
   - Style as ghost/outline button below primary Buy Now

Track 'page_view' event with path='landing' on mount.
  </action>
  <verify>
1. Hover over Buy Now button - href shows /checkout?path=buy
2. Visit /?path=buy - check localStorage has tb_entry_path='buy'
3. Secondary "Create Your Route" button visible and links correctly
  </verify>
  <done>
Landing page tracks entry path and routes users to appropriate conversion path.
  </done>
</task>

<task type="auto">
  <name>Task 2: Connect checkout page to real Stripe flow</name>
  <files>app/checkout/page.tsx</files>
  <action>
Update checkout page to use real Stripe Checkout (redirect flow).

1. Remove mock payment form - Stripe Checkout handles card collection.

2. New checkout flow:
   - User fills: email, password, name (account creation)
   - User clicks "Continue to Payment"
   - Frontend calls POST /api/payments/checkout with:
     - email, password, name
     - entry_path from getTrackingContext()
   - Backend creates account (if new) and Stripe Checkout session
   - Backend returns checkout_url
   - Frontend redirects to Stripe Checkout (window.location.href = checkout_url)
   - Stripe handles card collection
   - Stripe redirects to /checkout/success?session_id={id}

3. Form updates:
   - Keep: email, password, name fields
   - Remove: card number, expiry, CVC fields
   - Update button: "Continue to Payment" (not "Pay $29.99")
   - Add note: "You'll be redirected to Stripe's secure checkout"
   - Show Stripe badge/logo for trust

4. Handle logged-in users:
   - Check for existing token in localStorage
   - If logged in, skip account creation fields
   - Show "Logged in as {email}" with logout link
   - Just show "Continue to Payment" button

5. Error handling:
   - Show inline error if account creation fails
   - Show error if Stripe session creation fails

Track 'checkout_started' event when form is submitted (before redirect).
  </action>
  <verify>
1. Visit /checkout (logged out)
2. Fill email, password, name
3. Click "Continue to Payment"
4. Verify redirect to Stripe Checkout (checkout.stripe.com)
  </verify>
  <done>
Checkout page collects account info then redirects to Stripe Checkout.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create checkout success page</name>
  <files>app/checkout/success/page.tsx</files>
  <action>
Create success page for post-purchase flow.

1. Page receives ?session_id= from Stripe redirect

2. On mount:
   - Call GET /api/payments/session/{session_id} to verify payment
   - If payment successful, show success UI
   - If pending/failed, show appropriate message
   - Track 'purchase_completed' event with amount from session

3. Success UI:
   - Green checkmark icon
   - "Welcome to Thunderbird!"
   - "Your account is ready. Let's set up your first route."
   - Show what's included:
     - $10 SMS credits
     - Unlimited custom routes
     - No monthly fees
   - Primary CTA: "Create Your First Route" -> /create
   - Secondary: "Browse Route Library" -> /library

4. If user came from "create-first" path (check entry_path in session metadata):
   - Different messaging: "Your route is now active!"
   - Show route details if route_id in metadata
   - CTA: "View My Routes" -> /routes

5. Store auth token if returned from backend (user is now logged in).

6. Handle edge cases:
   - Session not found: Show error, link to support
   - Payment pending: "Payment processing, you'll receive email confirmation"
   - Already used session: Redirect to /routes
  </action>
  <verify>
1. Complete Stripe Checkout (test mode)
2. Verify redirect to /checkout/success?session_id=...
3. Success page shows correct messaging
4. "Create Your First Route" button works
  </verify>
  <done>
Checkout success page verifies payment and directs user to create route.
  </done>
</task>

</tasks>

<verification>
End-to-end test of "Buy Now" path:
1. Visit landing page /
2. Click "Buy Now" button
3. Redirected to /checkout?path=buy
4. Fill account creation form
5. Click "Continue to Payment"
6. Complete Stripe Checkout (use test card 4242424242424242)
7. Redirected to /checkout/success
8. See success page with "Create Your First Route" CTA
9. Click CTA, arrive at /create
10. Verify analytics: page_view (landing), checkout_started, purchase_completed
11. Verify Stripe metadata has entry_path='buy'
</verification>

<success_criteria>
- Buy Now buttons include path=buy parameter
- Checkout page creates account and redirects to Stripe
- Stripe Checkout collects payment
- Success page verifies payment and directs to route creation
- Entry path tracked through to Stripe metadata
- User is logged in after purchase
</success_criteria>

<output>
After completion, create `.planning/phases/04-user-flows/04-03-SUMMARY.md` using the standard summary template.
</output>
