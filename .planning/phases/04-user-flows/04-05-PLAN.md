---
phase: 04-user-flows
plan: 05
type: execute
wave: 4
depends_on: ["04-02", "04-03", "04-04"]
files_modified:
  - backend/app/models/analytics.py
  - backend/scripts/analytics_report.py
autonomous: true

must_haves:
  truths:
    - "Analytics can report conversion rate by entry path"
    - "A/B variant data is available for analysis"
    - "Both conversion paths work end-to-end"
    - "All FLOW requirements verified complete"
  artifacts:
    - path: "backend/scripts/analytics_report.py"
      provides: "CLI script for conversion analytics"
      exports: ["main"]
  key_links:
    - from: "backend/scripts/analytics_report.py"
      to: "backend/app/models/analytics.py"
      via: "analytics_store queries"
      pattern: "analytics_store\\.get_"
---

<objective>
Verify Phase 4 integration and create analytics reporting capability (FLOW-04).

Purpose: Ensure both conversion paths work correctly and analytics data is usable for A/B analysis. This plan validates the phase is complete and enables data-driven optimization.

Output:
- Analytics query functions for conversion reporting
- CLI script to generate conversion reports
- Verified end-to-end flows for both paths
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md (FLOW-01 through FLOW-06)
@.planning/phases/04-user-flows/04-02-SUMMARY.md
@.planning/phases/04-user-flows/04-03-SUMMARY.md
@.planning/phases/04-user-flows/04-04-SUMMARY.md

# Analytics model from Plan 01
@backend/app/models/analytics.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add analytics query functions</name>
  <files>backend/app/models/analytics.py</files>
  <action>
Add query functions to analytics_store for conversion reporting.

New methods on AnalyticsStore class:

1. get_funnel_by_path(start_date: date, end_date: date) -> dict:
   ```python
   # Returns:
   {
       'create': {
           'page_views': 150,
           'routes_created': 80,
           'simulators_viewed': 75,
           'checkouts_started': 40,
           'purchases_completed': 25,
           'conversion_rate': 0.167  # purchases / page_views
       },
       'buy': {
           'page_views': 200,
           'checkouts_started': 100,
           'purchases_completed': 60,
           'conversion_rate': 0.30
       },
       'organic': { ... }
   }
   ```

2. get_conversion_by_variant(start_date: date, end_date: date) -> dict:
   ```python
   # Returns:
   {
       'A': {
           'sessions': 175,
           'purchases': 40,
           'conversion_rate': 0.229,
           'avg_revenue': 2999  # cents
       },
       'B': {
           'sessions': 175,
           'purchases': 45,
           'conversion_rate': 0.257,
           'avg_revenue': 2999
       }
   }
   ```

3. get_daily_events(start_date: date, end_date: date, event_type: str) -> list:
   ```python
   # Returns list of (date, count) tuples for charting
   [('2026-01-20', 45), ('2026-01-21', 52), ...]
   ```

SQL queries should:
- Group by entry_path or variant
- Count distinct sessions (use session_start or similar identifier)
- Calculate conversion as purchases / unique sessions
- Handle NULL entry_path as 'organic'
  </action>
  <verify>
Write unit tests that insert sample analytics events and verify query results.
  </verify>
  <done>
Analytics store can query conversion data by path and A/B variant.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create analytics report CLI</name>
  <files>backend/scripts/analytics_report.py</files>
  <action>
Create CLI script for generating conversion reports.

Usage:
```bash
python backend/scripts/analytics_report.py --days 7
python backend/scripts/analytics_report.py --start 2026-01-01 --end 2026-01-31
python backend/scripts/analytics_report.py --format json
```

Script functionality:

1. Parse arguments:
   - --days N: Last N days (default 7)
   - --start DATE: Start date (YYYY-MM-DD)
   - --end DATE: End date (YYYY-MM-DD)
   - --format: 'text' (default) or 'json'

2. Generate report sections:

   a) Conversion by Path:
   ```
   CONVERSION BY ENTRY PATH (Last 7 days)
   =====================================
   Path         Views   Checkouts   Purchases   Conv%
   create       150     40          25          16.7%
   buy          200     100         60          30.0%
   organic      100     30          15          15.0%
   =====================================
   Total        450     170         100         22.2%
   ```

   b) A/B Variant Performance:
   ```
   A/B VARIANT PERFORMANCE
   =======================
   Variant   Sessions   Purchases   Conv%
   A         225        50          22.2%
   B         225        50          22.2%
   =======================
   Difference: +0.0% (not significant)
   ```

   c) Daily Trend:
   ```
   DAILY PURCHASES
   ===============
   2026-01-20: ████████████ 12
   2026-01-21: ██████████████████ 18
   ...
   ```

3. JSON format outputs same data as structured JSON for programmatic use.

4. Add to requirements: tabulate (for text tables), or use simple string formatting.
  </action>
  <verify>
```bash
# Insert some test data first, then:
python backend/scripts/analytics_report.py --days 7
```
Should output formatted report.
  </verify>
  <done>
CLI script generates readable conversion reports from analytics data.
  </done>
</task>

<task type="auto">
  <name>Task 3: End-to-end verification of all flows</name>
  <files>(verification only - no files modified)</files>
  <action>
Verify all FLOW requirements are implemented correctly.

Verification checklist:

FLOW-01: Phone simulator shows example SMS forecast for user's route
- [ ] Visit /create/preview?id={routeId}
- [ ] PhoneSimulator renders with waypoint name and SMS code
- [ ] SMS format matches labeled spaced format from formatter.py

FLOW-02: "Create first" path
- [ ] Start at /create (no auth required)
- [ ] Upload GPX, add waypoints
- [ ] Click "Preview SMS Forecast" -> /create/preview
- [ ] See simulator with waypoint
- [ ] Click "Activate Route" -> PaywallModal
- [ ] Complete payment -> success page with SMS codes

FLOW-03: "Buy now" path
- [ ] Click "Buy Now" on landing page
- [ ] URL includes ?path=buy
- [ ] Complete checkout -> Stripe redirect
- [ ] Return to success page
- [ ] Directed to create route

FLOW-04: Analytics tracks conversion by path
- [ ] Check analytics_events table has records
- [ ] Events include: page_view, route_created, simulator_viewed, checkout_started, purchase_completed
- [ ] entry_path populated correctly
- [ ] Run analytics_report.py - shows data by path

FLOW-05: Paywall appears after simulator
- [ ] On /create/preview, click "Activate Route"
- [ ] PaywallModal appears (not redirect)
- [ ] Modal has account creation + payment
- [ ] Submit redirects to Stripe

FLOW-06: Entry path tracked through purchase
- [ ] Complete purchase via "create" path
- [ ] Check Stripe dashboard - metadata has entry_path='create'
- [ ] Complete purchase via "buy" path
- [ ] Check Stripe dashboard - metadata has entry_path='buy'

Document any issues found in the summary.
  </action>
  <verify>
All checklist items verified manually. Screenshot or log evidence for each.
  </verify>
  <done>
All FLOW requirements verified working. Any issues documented for follow-up.
  </done>
</task>

</tasks>

<verification>
1. Analytics queries return correct data
2. CLI report generates readable output
3. All FLOW-01 through FLOW-06 requirements verified
4. Both conversion paths work end-to-end
5. Analytics data flows from frontend to backend to reports
</verification>

<success_criteria>
- Analytics report shows conversion by path and A/B variant
- CLI script is documented and usable
- All 6 FLOW requirements verified complete
- Both "create first" and "buy now" paths work correctly
- Entry path appears in Stripe metadata for all purchases
- Phase 4 ready to mark complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-user-flows/04-05-SUMMARY.md` using the standard summary template.

Include final requirement verification status in summary.
</output>
