---
phase: 04-user-flows
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/simulator/PhoneSimulator.tsx
  - app/lib/analytics.ts
  - backend/app/models/analytics.py
  - backend/app/routers/analytics.py
autonomous: true

must_haves:
  truths:
    - "Phone simulator component renders realistic iPhone/Watch SMS preview"
    - "Analytics utility tracks entry path on first page visit"
    - "Analytics events can be logged to backend database"
    - "A/B variant assignment persists across sessions"
  artifacts:
    - path: "app/components/simulator/PhoneSimulator.tsx"
      provides: "Reusable phone mockup component with SMS bubble"
      exports: ["PhoneSimulator"]
    - path: "app/lib/analytics.ts"
      provides: "Path tracking, A/B assignment, event logging"
      exports: ["initPathTracking", "getTrackingContext", "trackEvent"]
    - path: "backend/app/models/analytics.py"
      provides: "Analytics event model for database storage"
      exports: ["AnalyticsEvent", "analytics_store"]
    - path: "backend/app/routers/analytics.py"
      provides: "POST /api/analytics endpoint"
      exports: ["router"]
  key_links:
    - from: "app/lib/analytics.ts"
      to: "/api/analytics"
      via: "fetch POST on trackEvent"
      pattern: "fetch.*api/analytics"
    - from: "backend/app/routers/analytics.py"
      to: "backend/app/models/analytics.py"
      via: "analytics_store.create"
      pattern: "analytics_store\\.create"
---

<objective>
Create foundation components for Phase 4: reusable PhoneSimulator component and analytics infrastructure.

Purpose: These are shared dependencies for both conversion paths. The PhoneSimulator shows users what SMS forecasts look like, and analytics tracks which path users take through purchase.

Output:
- PhoneSimulator React component (extracted from landing page CSS)
- Client-side analytics utilities (path tracking, A/B assignment)
- Backend analytics event storage
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-user-flows/04-RESEARCH.md

# Existing phone mockup CSS to extract
@app/page.tsx (lines 44-135 - iPhone and Watch mockups)

# Backend patterns
@backend/app/services/payments.py (Stripe metadata pattern)
@backend/app/models/payments.py (model pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PhoneSimulator component</name>
  <files>app/components/simulator/PhoneSimulator.tsx</files>
  <action>
Create a reusable PhoneSimulator component by extracting the CSS from app/page.tsx Hero section (lines 44-135).

Component requirements:
1. Props interface:
   - content: string (SMS message to display)
   - variant?: 'iphone' | 'watch' (default 'iphone')
   - animateTyping?: boolean (default false - typing effect)
   - className?: string (for positioning)

2. iPhone variant (default):
   - 280x560px black frame with 36px border-radius
   - Notch at top (100x22px, rounded bottom)
   - White screen with 26px border-radius
   - Header: "Thunderbird" text
   - Gray message bubble (#e5e5ea) with proper SMS styling
   - Use whitespace: pre-wrap for SMS formatting

3. Watch variant:
   - 180x220px dark frame with orange digital crown
   - 44px border-radius, thinner padding
   - White text on black screen (9px font)

4. Typing animation (when animateTyping=true):
   - Start with empty content
   - Reveal characters progressively (30ms per char)
   - Use useEffect with interval cleanup

5. CSS: Use Tailwind classes matching existing landing page styles.

Do NOT use any external device mockup libraries - CSS-only approach as per research decision.
  </action>
  <verify>
Create a simple test in app/components/simulator/PhoneSimulator.test.tsx that renders the component with sample SMS content and checks that the content appears in the DOM.
  </verify>
  <done>
PhoneSimulator component renders both variants, accepts dynamic content, and typing animation works when enabled.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create client-side analytics utilities</name>
  <files>app/lib/analytics.ts</files>
  <action>
Create analytics utility module for path tracking and A/B assignment.

Functions to implement:

1. initPathTracking(searchParams: URLSearchParams):
   - On first visit only (check localStorage 'tb_entry_path')
   - Extract path from ?path= URL param (default: 'organic')
   - Generate A/B variant: Math.random() < 0.5 ? 'A' : 'B'
   - Store in localStorage:
     - tb_entry_path: 'create' | 'buy' | 'organic'
     - tb_variant: 'A' | 'B'
     - tb_session_start: ISO timestamp

2. getTrackingContext(): returns { entry_path, variant, session_start } or null if not set

3. trackEvent(event: string, properties?: Record<string, any>): Promise<void>
   - POST to /api/analytics with:
     - event name
     - variant and entry_path from localStorage
     - timestamp
     - additional properties
   - Fire and forget (don't await, don't block UI)
   - Catch errors silently (analytics should never break the app)

4. Events to support:
   - page_view (with path property)
   - route_created (with waypoint_count)
   - simulator_viewed (with route_id)
   - checkout_started (with entry_path)
   - purchase_completed (with amount_cents, entry_path)

All functions should be SSR-safe (check typeof window !== 'undefined').
  </action>
  <verify>
Test by adding a temporary console.log in initPathTracking and calling it from app/layout.tsx or a test page. Verify localStorage values are set correctly.
  </verify>
  <done>
Analytics utilities initialize path tracking on first visit, assign A/B variant, and can log events to backend.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create backend analytics storage</name>
  <files>backend/app/models/analytics.py, backend/app/routers/analytics.py, backend/app/main.py</files>
  <action>
Create backend infrastructure to store analytics events.

1. backend/app/models/analytics.py:
   - AnalyticsEvent dataclass:
     - id: int
     - event: str (e.g., 'page_view', 'purchase_completed')
     - variant: Optional[str] ('A' or 'B')
     - entry_path: Optional[str] ('create', 'buy', 'organic')
     - properties: Optional[dict] (JSON blob)
     - account_id: Optional[int] (if user is logged in)
     - created_at: datetime

   - AnalyticsStore class with:
     - create(event, variant, entry_path, properties, account_id) -> AnalyticsEvent
     - get_conversion_by_path(start_date, end_date) -> dict (for later reporting)

   - Use SQLite table 'analytics_events' with JSON column for properties
   - Follow same pattern as backend/app/models/payments.py (Order model)

2. backend/app/routers/analytics.py:
   - POST /api/analytics endpoint
   - Request body: { event, variant?, entry_path?, properties?, account_id? }
   - Returns 201 Created (no response body needed)
   - Include CORS headers for frontend calls
   - No authentication required (analytics should work for anonymous users)

3. backend/app/main.py:
   - Add analytics router: app.include_router(analytics.router, prefix="/api")

Create migration for analytics_events table using Alembic pattern from Phase 1.
  </action>
  <verify>
curl -X POST http://localhost:8000/api/analytics \
  -H "Content-Type: application/json" \
  -d '{"event": "test_event", "variant": "A", "entry_path": "organic"}'

Should return 201 status.
  </verify>
  <done>
Analytics events can be POSTed to /api/analytics and are stored in SQLite database.
  </done>
</task>

</tasks>

<verification>
1. PhoneSimulator renders with sample SMS content:
   - Import and render in a test page
   - Both iPhone and Watch variants display correctly

2. Analytics initialization:
   - Visit /?path=create in browser
   - Check localStorage has tb_entry_path='create', tb_variant set

3. Backend analytics:
   - POST request to /api/analytics succeeds
   - Check SQLite database has analytics_events table with record
</verification>

<success_criteria>
- PhoneSimulator component exists and renders realistic phone mockups
- Analytics tracks entry path on first visit (stored in localStorage)
- A/B variant assigned and persisted
- Backend accepts and stores analytics events
- All components are SSR-safe
</success_criteria>

<output>
After completion, create `.planning/phases/04-user-flows/04-01-SUMMARY.md` using the standard summary template.
</output>
