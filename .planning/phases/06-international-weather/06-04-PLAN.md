---
phase: 06-international-weather
plan: 04
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - backend/app/services/weather/providers/metoffice.py
autonomous: true
user_setup:
  - service: metoffice
    why: "UK weather forecasts require Met Office API key"
    env_vars:
      - name: METOFFICE_API_KEY
        source: "Met Office Weather DataHub -> Register -> Get API key from dashboard"
    dashboard_config:
      - task: "Register for free account"
        location: "https://datahub.metoffice.gov.uk/register"
      - task: "Subscribe to Site Specific API (free tier)"
        location: "Weather DataHub dashboard -> Site Specific -> Subscribe"

must_haves:
  truths:
    - "Met Office provider fetches forecasts for UK coordinates"
    - "Provider handles missing API key gracefully"
    - "Forecasts normalize to NormalizedDailyForecast format"
    - "Provider respects 360 calls/day free tier limit"
  artifacts:
    - path: "backend/app/services/weather/providers/metoffice.py"
      provides: "Met Office Weather DataHub provider for UK"
      exports: ["MetOfficeProvider"]
  key_links:
    - from: "backend/app/services/weather/providers/metoffice.py"
      to: "backend/app/services/weather/base.py"
      via: "implements WeatherProvider ABC"
      pattern: "class MetOfficeProvider\\(WeatherProvider\\)"
    - from: "backend/app/services/weather/providers/metoffice.py"
      to: "https://datahub.metoffice.gov.uk"
      via: "HTTP API calls"
      pattern: "data\\.hub\\.api\\.metoffice\\.gov\\.uk"
---

<objective>
Implement Met Office Weather DataHub provider for UK weather forecasts.

Purpose: UK is a key hiking destination (Lake District, Scottish Highlands, Wales). Met Office is the official UK source. This covers WTHR-03.

Output: MetOfficeProvider that fetches forecasts for UK coordinates using Weather DataHub API.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-international-weather/06-CONTEXT.md
@.planning/phases/06-international-weather/06-RESEARCH.md
@.planning/phases/06-international-weather/06-01-SUMMARY.md
@backend/app/services/weather/base.py
@backend/app/services/weather/providers/openmeteo.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Met Office provider structure</name>
  <files>backend/app/services/weather/providers/metoffice.py</files>
  <action>
Create MetOfficeProvider implementing WeatherProvider ABC.

IMPORTANT: DataPoint service is DECOMMISSIONED (research pitfall #2). Use Weather DataHub.

Base configuration:
1. API_BASE = "https://data.hub.api.metoffice.gov.uk/sitespecific/v0"
2. API key from environment variable: METOFFICE_API_KEY
3. Headers:
   ```python
   headers = {
       "apikey": api_key,
       "Accept": "application/json"
   }
   ```

Provider properties:
- provider_name = "Met Office"
- supports_alerts = False (alerts not in free tier)

Key method structure:
```python
class MetOfficeProvider(WeatherProvider):
    def __init__(self):
        self.api_key = os.environ.get("METOFFICE_API_KEY")

    async def get_forecast(self, lat, lon, days=7):
        if not self.api_key:
            raise ValueError("METOFFICE_API_KEY not configured")
        ...

    async def get_alerts(self, lat, lon):
        return []  # Not supported in free tier
```

Handle missing API key by raising clear exception (fallback will handle).
  </action>
  <verify>
```bash
cd /Users/andrewhall/thunderbird-web/backend
python -c "
from app.services.weather.providers.metoffice import MetOfficeProvider
provider = MetOfficeProvider()
print(f'Provider name: {provider.provider_name}')
print(f'Supports alerts: {provider.supports_alerts}')
print('Structure OK')
"
```
  </verify>
  <done>Met Office provider structure created with correct API configuration</done>
</task>

<task type="auto">
  <name>Task 2: Implement Met Office forecast fetching</name>
  <files>backend/app/services/weather/providers/metoffice.py</files>
  <action>
Implement forecast fetching from Weather DataHub.

Endpoint: GET /point/hourly or /point/daily
```
https://data.hub.api.metoffice.gov.uk/sitespecific/v0/point/hourly
?latitude={lat}
&longitude={lon}
```

Response structure (Site Specific API):
```json
{
  "type": "FeatureCollection",
  "features": [{
    "properties": {
      "timeSeries": [
        {
          "time": "2026-01-21T12:00Z",
          "screenTemperature": 8.5,
          "maxScreenAirTemp": 10.2,
          "minScreenAirTemp": 6.8,
          "screenRelativeHumidity": 75,
          "windSpeed10m": 15.5,
          "windGustSpeed10m": 25.3,
          "windDirectionFrom10m": 225,
          "precipitationRate": 0.5,
          "probOfPrecipitation": 40,
          "totalSnowAmount": 0,
          "visibility": 15000,
          "significantWeatherCode": 3
        }
      ]
    }
  }]
}
```

Normalization:
1. Temperature already in Celsius
2. Wind speed in m/s - convert to km/h (* 3.6)
3. Wind direction in degrees - convert to compass
4. precipitationRate is mm/hr - calculate total from period duration
5. probOfPrecipitation is 0-100%
6. totalSnowAmount in mm (convert to cm / 10)
7. Map significantWeatherCode to description (codes documented in Met Office spec)

Rate limit consideration:
- Free tier: 360 calls/day
- Use caching layer (from 06-01) to minimize calls
- Don't fetch more frequently than needed
  </action>
  <verify>
```bash
cd /Users/andrewhall/thunderbird-web/backend
# Only test if API key is configured
python -c "
import os
from app.services.weather.providers.metoffice import MetOfficeProvider
import asyncio

async def test():
    provider = MetOfficeProvider()
    if not os.environ.get('METOFFICE_API_KEY'):
        print('METOFFICE_API_KEY not set - skipping live test')
        print('Provider structure verified')
        return

    # Test with Lake District coordinates
    forecast = await provider.get_forecast(54.4609, -3.0886, days=3)
    print(f'Provider: {forecast.provider}')
    print(f'Periods: {len(forecast.periods)}')
    if forecast.periods:
        p = forecast.periods[0]
        print(f'First: {p.temp_min}C to {p.temp_max}C')
    print('Met Office forecast OK')

asyncio.run(test())
"
```
  </verify>
  <done>Met Office forecasts are fetched and normalized (when API key available)</done>
</task>

<task type="auto">
  <name>Task 3: Add weather code to description mapping</name>
  <files>backend/app/services/weather/providers/metoffice.py</files>
  <action>
Create mapping from Met Office weather codes to human-readable descriptions.

Met Office significant weather codes:
```python
WEATHER_CODES = {
    -1: "Trace rain",
    0: "Clear night",
    1: "Sunny day",
    2: "Partly cloudy (night)",
    3: "Partly cloudy (day)",
    4: "Not used",
    5: "Mist",
    6: "Fog",
    7: "Cloudy",
    8: "Overcast",
    9: "Light rain shower (night)",
    10: "Light rain shower (day)",
    11: "Drizzle",
    12: "Light rain",
    13: "Heavy rain shower (night)",
    14: "Heavy rain shower (day)",
    15: "Heavy rain",
    16: "Sleet shower (night)",
    17: "Sleet shower (day)",
    18: "Sleet",
    19: "Hail shower (night)",
    20: "Hail shower (day)",
    21: "Hail",
    22: "Light snow shower (night)",
    23: "Light snow shower (day)",
    24: "Light snow",
    25: "Heavy snow shower (night)",
    26: "Heavy snow shower (day)",
    27: "Heavy snow",
    28: "Thunder shower (night)",
    29: "Thunder shower (day)",
    30: "Thunder",
}
```

Use this mapping in normalization to populate the `description` field of NormalizedForecast.

Default to "Unknown" for unmapped codes.
  </action>
  <verify>
```bash
cd /Users/andrewhall/thunderbird-web/backend
python -c "
from app.services.weather.providers.metoffice import WEATHER_CODES
assert WEATHER_CODES[1] == 'Sunny day'
assert WEATHER_CODES[15] == 'Heavy rain'
assert WEATHER_CODES[27] == 'Heavy snow'
print('Weather codes mapped correctly')
"
```
  </verify>
  <done>Weather codes are mapped to human-readable descriptions</done>
</task>

</tasks>

<verification>
After all tasks:
1. MetOfficeProvider implements WeatherProvider ABC
2. API key loaded from METOFFICE_API_KEY environment variable
3. Missing API key raises clear exception
4. Weather codes mapped to descriptions
5. Wind speed converted from m/s to km/h
6. supports_alerts returns False (not in free tier)
</verification>

<success_criteria>
- [ ] MetOfficeProvider implements WeatherProvider ABC
- [ ] Uses Weather DataHub API (NOT deprecated DataPoint)
- [ ] API key from environment variable
- [ ] Wind speed converted to km/h
- [ ] Weather codes mapped to descriptions
- [ ] Handles missing API key gracefully
- [ ] supports_alerts returns False
</success_criteria>

<output>
After completion, create `.planning/phases/06-international-weather/06-04-SUMMARY.md`
</output>
