---
phase: 06-international-weather
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - backend/app/services/weather/providers/nws.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "NWS provider fetches forecasts for US coordinates"
    - "NWS provider fetches active weather alerts for US coordinates"
    - "Grid info is cached to avoid redundant /points calls"
    - "Forecasts normalize to NormalizedDailyForecast format"
  artifacts:
    - path: "backend/app/services/weather/providers/nws.py"
      provides: "National Weather Service provider for USA"
      exports: ["NWSProvider"]
  key_links:
    - from: "backend/app/services/weather/providers/nws.py"
      to: "backend/app/services/weather/base.py"
      via: "implements WeatherProvider ABC"
      pattern: "class NWSProvider\\(WeatherProvider\\)"
    - from: "backend/app/services/weather/providers/nws.py"
      to: "https://api.weather.gov"
      via: "HTTP API calls"
      pattern: "api\\.weather\\.gov"
---

<objective>
Implement National Weather Service (NWS) provider for USA weather forecasts.

Purpose: NWS is the gold standard free weather API - no auth required, excellent documentation, includes comprehensive alerts. This covers WTHR-01.

Output: NWSProvider that fetches forecasts and alerts for any US coordinates.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-international-weather/06-CONTEXT.md
@.planning/phases/06-international-weather/06-RESEARCH.md
@.planning/phases/06-international-weather/06-01-SUMMARY.md
@backend/app/services/weather/base.py
@backend/app/services/weather/providers/openmeteo.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement NWS grid lookup with caching</name>
  <files>backend/app/services/weather/providers/nws.py</files>
  <action>
Create NWSProvider implementing WeatherProvider ABC.

NWS API requires a two-step process:
1. Call `/points/{lat},{lon}` to get grid metadata
2. Use the returned forecast URL for actual forecast data

Implementation:
1. BASE_URL = "https://api.weather.gov"

2. User-Agent header is REQUIRED (research pitfall #1):
   ```python
   headers = {
       "User-Agent": "(Thunderbird-Web, support@thunderbird.app)",
       "Accept": "application/geo+json"
   }
   ```

3. Create internal `_GridInfo` dataclass:
   - office: str (e.g., "OKX")
   - gridX: int
   - gridY: int
   - forecast_url: str
   - forecast_hourly_url: str

4. Implement `_get_grid_info(lat, lon) -> _GridInfo`:
   - Cache grid info in instance dict (grid doesn't change for coordinates)
   - Cache key: f"{lat:.4f},{lon:.4f}"
   - Call GET /points/{lat},{lon}
   - Parse response.json()["properties"]
   - Return _GridInfo with extracted values

5. Handle errors gracefully:
   - 404: coordinates outside US coverage
   - 500/503: NWS API issues (should fallback)
   - Timeout: raise exception for fallback handling
  </action>
  <verify>
```bash
cd /Users/andrewhall/thunderbird-web/backend
python -c "
from app.services.weather.providers.nws import NWSProvider
import asyncio

async def test():
    provider = NWSProvider()
    # Test grid lookup for NYC
    grid = await provider._get_grid_info(40.7128, -74.0060)
    print(f'Grid: {grid.office} ({grid.gridX}, {grid.gridY})')
    assert grid.office is not None
    assert grid.forecast_url.startswith('https://')
    print('Grid lookup OK')

asyncio.run(test())
"
```
  </verify>
  <done>NWS grid lookup works and caches results</done>
</task>

<task type="auto">
  <name>Task 2: Implement NWS forecast fetching and normalization</name>
  <files>backend/app/services/weather/providers/nws.py</files>
  <action>
Add forecast fetching to NWSProvider.

Implement `get_forecast(lat, lon, days=7) -> NormalizedDailyForecast`:

1. Get grid info using _get_grid_info (cached)

2. Fetch forecast from grid.forecast_url:
   - Response is GeoJSON with 14 periods (7 days x 2 periods)
   - Each period has: name, startTime, endTime, temperature, temperatureUnit, windSpeed, windDirection, shortForecast, detailedForecast

3. Normalize NWS response to NormalizedForecast:
   - NWS gives temperature in Fahrenheit - convert to Celsius: (F - 32) * 5/9
   - NWS windSpeed is string like "10 to 15 mph" - parse and convert to km/h
   - NWS windDirection is string like "SW" - use directly
   - Extract rain probability from detailedForecast text if mentioned
   - NWS doesn't provide: rain_amount, freezing_level, snow_amount, cloud_cover (estimate from shortForecast)

4. Parse precipitation from detailedForecast:
   - Look for "chance of rain" patterns
   - Extract percentage if mentioned
   - Default to 0 if no rain mentioned

5. Set provider_name = "NWS"
6. Set is_fallback = False

Handle edge cases:
- Some periods may be "Tonight" vs "Monday Night" - normalize
- Temperature units may vary (usually Fahrenheit)
  </action>
  <verify>
```bash
cd /Users/andrewhall/thunderbird-web/backend
python -c "
from app.services.weather.providers.nws import NWSProvider
import asyncio

async def test():
    provider = NWSProvider()
    # Test forecast for Denver, CO (known hiking area)
    forecast = await provider.get_forecast(39.7392, -104.9903, days=3)
    print(f'Provider: {forecast.provider}')
    print(f'Periods: {len(forecast.periods)}')
    if forecast.periods:
        p = forecast.periods[0]
        print(f'First: {p.temp_min}C to {p.temp_max}C, wind {p.wind_avg}-{p.wind_max} km/h')
    assert forecast.provider == 'NWS'
    assert len(forecast.periods) > 0
    print('Forecast fetch OK')

asyncio.run(test())
"
```
  </verify>
  <done>NWS forecasts are fetched and normalized to standard format</done>
</task>

<task type="auto">
  <name>Task 3: Implement NWS alerts fetching</name>
  <files>backend/app/services/weather/providers/nws.py</files>
  <action>
Add alerts support to NWSProvider.

Implement `get_alerts(lat, lon) -> List[WeatherAlert]`:

1. Endpoint: GET /alerts/active?point={lat},{lon}
   - Use point parameter to filter (research pitfall #5: avoid fetching all alerts)

2. Response is GeoJSON FeatureCollection:
   ```json
   {
     "features": [
       {
         "properties": {
           "event": "Winter Storm Warning",
           "headline": "Winter Storm Warning...",
           "severity": "Severe",
           "urgency": "Expected",
           "expires": "2026-01-22T18:00:00-05:00"
         }
       }
     ]
   }
   ```

3. Map to WeatherAlert dataclass:
   - event: properties.event
   - headline: properties.headline
   - severity: properties.severity
   - urgency: properties.urgency
   - expires: parse ISO datetime from properties.expires

4. Return empty list if no alerts or API error (don't fail on alerts)

5. Set `supports_alerts = True` property

Note: Alerts are important for hiking safety - prioritize display per CONTEXT.md decision.
  </action>
  <verify>
```bash
cd /Users/andrewhall/thunderbird-web/backend
python -c "
from app.services.weather.providers.nws import NWSProvider
import asyncio

async def test():
    provider = NWSProvider()
    # Check alerts support
    assert provider.supports_alerts == True

    # Fetch alerts for Denver (may or may not have active alerts)
    alerts = await provider.get_alerts(39.7392, -104.9903)
    print(f'Found {len(alerts)} active alerts')
    for alert in alerts[:3]:
        print(f'  - {alert.event}: {alert.severity}')
    print('Alerts fetch OK')

asyncio.run(test())
"
```
  </verify>
  <done>NWS alerts are fetched and converted to WeatherAlert format</done>
</task>

</tasks>

<verification>
After all tasks:
1. NWSProvider is importable from app.services.weather.providers.nws
2. Grid info lookup works and caches results
3. Forecasts fetch successfully for US coordinates
4. Forecasts normalize to Celsius and km/h
5. Alerts fetch without failing (even if no active alerts)
6. Provider correctly identifies as NWS with alerts support
</verification>

<success_criteria>
- [ ] NWSProvider implements WeatherProvider ABC
- [ ] Grid info cached to avoid redundant /points calls
- [ ] Forecasts normalized to Celsius temperature
- [ ] Wind speed converted from mph to km/h
- [ ] Alerts fetch with point parameter filtering
- [ ] User-Agent header included in all requests
- [ ] Errors handled gracefully (don't crash on API issues)
</success_criteria>

<output>
After completion, create `.planning/phases/06-international-weather/06-02-SUMMARY.md`
</output>
