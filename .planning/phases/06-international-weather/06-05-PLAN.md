---
phase: 06-international-weather
plan: 05
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - backend/app/services/weather/providers/openmeteo.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Open-Meteo provider supports country-specific models"
    - "France uses Meteo-France AROME model via Open-Meteo"
    - "Italy uses DWD ICON-EU model via Open-Meteo"
    - "Switzerland uses MeteoSwiss ICON-CH model via Open-Meteo"
    - "New Zealand and South Africa use best_match model"
  artifacts:
    - path: "backend/app/services/weather/providers/openmeteo.py"
      provides: "Open-Meteo provider with country-specific model support"
      exports: ["OpenMeteoProvider", "OpenMeteoModel"]
  key_links:
    - from: "backend/app/services/weather/providers/openmeteo.py"
      to: "https://api.open-meteo.com"
      via: "HTTP API calls"
      pattern: "api\\.open-meteo\\.com"
---

<objective>
Extend Open-Meteo provider to support country-specific models for France, Italy, Switzerland, New Zealand, and South Africa.

Purpose: These 5 countries don't have easy-to-access native APIs. Open-Meteo provides the same model data (Meteo-France, MeteoSwiss, DWD ICON) through a unified interface. This covers WTHR-04 through WTHR-08.

Output: OpenMeteoProvider with model parameter supporting country-optimized endpoints.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-international-weather/06-CONTEXT.md
@.planning/phases/06-international-weather/06-RESEARCH.md
@.planning/phases/06-international-weather/06-01-SUMMARY.md
@backend/app/services/weather/providers/openmeteo.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add model enumeration and endpoint mapping</name>
  <files>backend/app/services/weather/providers/openmeteo.py</files>
  <action>
Add OpenMeteoModel enum and endpoint mapping to OpenMeteoProvider.

From research, model-specific endpoints:
```python
from enum import Enum

class OpenMeteoModel(str, Enum):
    BEST_MATCH = "best_match"      # Default global
    METEOFRANCE = "meteofrance"    # France (AROME 1.5-2.5km)
    METEOSWISS = "meteoswiss"      # Switzerland (ICON-CH 1-2km)
    ICON_EU = "icon_eu"            # Italy/Europe (7km)
    GFS = "gfs"                    # Global fallback (25km)

MODEL_ENDPOINTS = {
    OpenMeteoModel.BEST_MATCH: "https://api.open-meteo.com/v1/forecast",
    OpenMeteoModel.METEOFRANCE: "https://api.open-meteo.com/v1/meteofrance",
    OpenMeteoModel.METEOSWISS: "https://api.open-meteo.com/v1/meteoswiss",
    OpenMeteoModel.ICON_EU: "https://api.open-meteo.com/v1/dwd-icon",
    OpenMeteoModel.GFS: "https://api.open-meteo.com/v1/gfs",
}

MODEL_NAMES = {
    OpenMeteoModel.BEST_MATCH: "Open-Meteo",
    OpenMeteoModel.METEOFRANCE: "Open-Meteo (Meteo-France)",
    OpenMeteoModel.METEOSWISS: "Open-Meteo (MeteoSwiss)",
    OpenMeteoModel.ICON_EU: "Open-Meteo (DWD ICON)",
    OpenMeteoModel.GFS: "Open-Meteo (GFS)",
}
```

Update constructor to accept model parameter:
```python
def __init__(self, model: OpenMeteoModel = OpenMeteoModel.BEST_MATCH):
    self.model = model
    self._endpoint = MODEL_ENDPOINTS[model]
```

Update provider_name property to return model-specific name.
  </action>
  <verify>
```bash
cd /Users/andrewhall/thunderbird-web/backend
python -c "
from app.services.weather.providers.openmeteo import OpenMeteoProvider, OpenMeteoModel

# Test model-specific providers
france = OpenMeteoProvider(model=OpenMeteoModel.METEOFRANCE)
print(f'France provider: {france.provider_name}')

swiss = OpenMeteoProvider(model=OpenMeteoModel.METEOSWISS)
print(f'Swiss provider: {swiss.provider_name}')

italy = OpenMeteoProvider(model=OpenMeteoModel.ICON_EU)
print(f'Italy provider: {italy.provider_name}')

default = OpenMeteoProvider()
print(f'Default provider: {default.provider_name}')

print('Model mapping OK')
"
```
  </verify>
  <done>OpenMeteoModel enum and endpoint mapping added</done>
</task>

<task type="auto">
  <name>Task 2: Test country-specific model endpoints</name>
  <files>backend/app/services/weather/providers/openmeteo.py</files>
  <action>
Verify each country-specific model works with real coordinates.

Test locations:
- France: Chamonix (45.9237, 6.8694) - Alps hiking
- Italy: Dolomites (46.4102, 11.8440)
- Switzerland: Zermatt (46.0207, 7.7491) - Matterhorn area
- New Zealand: Milford Sound (-44.6714, 167.9256)
- South Africa: Drakensberg (-29.4500, 29.2700)

Update get_forecast to use model-specific endpoint:
```python
async def get_forecast(self, lat, lon, days=7):
    params = {
        "latitude": lat,
        "longitude": lon,
        "hourly": "...",
        "timezone": "auto",
        "forecast_days": min(days, 16),
    }

    async with httpx.AsyncClient(timeout=30.0) as client:
        response = await client.get(self._endpoint, params=params)
        response.raise_for_status()
        return self._parse_response(response.json(), lat, lon)
```

Note: MeteoSwiss endpoint only covers Switzerland (will 404 for other locations).
ICON-EU covers Europe broadly. GFS covers globally.
  </action>
  <verify>
```bash
cd /Users/andrewhall/thunderbird-web/backend
python -c "
from app.services.weather.providers.openmeteo import OpenMeteoProvider, OpenMeteoModel
import asyncio

async def test_country(name, model, lat, lon):
    provider = OpenMeteoProvider(model=model)
    try:
        forecast = await provider.get_forecast(lat, lon, days=2)
        print(f'{name}: {len(forecast.periods)} periods, provider={forecast.provider}')
        return True
    except Exception as e:
        print(f'{name}: FAILED - {e}')
        return False

async def main():
    results = await asyncio.gather(
        test_country('France (Chamonix)', OpenMeteoModel.METEOFRANCE, 45.9237, 6.8694),
        test_country('Switzerland (Zermatt)', OpenMeteoModel.METEOSWISS, 46.0207, 7.7491),
        test_country('Italy (Dolomites)', OpenMeteoModel.ICON_EU, 46.4102, 11.8440),
        test_country('New Zealand (Milford)', OpenMeteoModel.BEST_MATCH, -44.6714, 167.9256),
        test_country('South Africa (Drakensberg)', OpenMeteoModel.BEST_MATCH, -29.4500, 29.2700),
    )
    print(f'Passed: {sum(results)}/5')

asyncio.run(main())
"
```
  </verify>
  <done>All country-specific models fetch forecasts successfully</done>
</task>

<task type="auto">
  <name>Task 3: Add country-to-model mapping helper</name>
  <files>backend/app/services/weather/providers/openmeteo.py</files>
  <action>
Add a helper function to get the optimal Open-Meteo model for a country.

```python
COUNTRY_TO_MODEL = {
    "FR": OpenMeteoModel.METEOFRANCE,  # France - AROME 1.5-2.5km
    "CH": OpenMeteoModel.METEOSWISS,   # Switzerland - ICON-CH 1-2km
    "IT": OpenMeteoModel.ICON_EU,      # Italy - ICON-EU 7km
    "NZ": OpenMeteoModel.BEST_MATCH,   # New Zealand - GFS/ECMWF
    "ZA": OpenMeteoModel.BEST_MATCH,   # South Africa - GFS/ECMWF
    # Other countries use BEST_MATCH by default
}

def get_model_for_country(country_code: str) -> OpenMeteoModel:
    """Get the optimal Open-Meteo model for a country code."""
    return COUNTRY_TO_MODEL.get(country_code.upper(), OpenMeteoModel.BEST_MATCH)

def create_provider_for_country(country_code: str) -> OpenMeteoProvider:
    """Create an OpenMeteoProvider configured for a specific country."""
    model = get_model_for_country(country_code)
    return OpenMeteoProvider(model=model)
```

This will be used by the router (Plan 06) to create the right provider.
  </action>
  <verify>
```bash
cd /Users/andrewhall/thunderbird-web/backend
python -c "
from app.services.weather.providers.openmeteo import get_model_for_country, create_provider_for_country, OpenMeteoModel

# Test country mapping
assert get_model_for_country('FR') == OpenMeteoModel.METEOFRANCE
assert get_model_for_country('CH') == OpenMeteoModel.METEOSWISS
assert get_model_for_country('IT') == OpenMeteoModel.ICON_EU
assert get_model_for_country('NZ') == OpenMeteoModel.BEST_MATCH
assert get_model_for_country('ZA') == OpenMeteoModel.BEST_MATCH
assert get_model_for_country('XX') == OpenMeteoModel.BEST_MATCH  # Unknown

# Test provider creation
fr_provider = create_provider_for_country('FR')
assert 'Meteo-France' in fr_provider.provider_name

print('Country mapping OK')
"
```
  </verify>
  <done>Country-to-model mapping helper functions added</done>
</task>

</tasks>

<verification>
After all tasks:
1. OpenMeteoModel enum defines all supported models
2. Each model maps to correct Open-Meteo endpoint
3. Provider name reflects the model used
4. Country-specific models fetch real forecasts
5. Country-to-model mapping covers FR, IT, CH, NZ, ZA
6. Unknown countries default to BEST_MATCH
</verification>

<success_criteria>
- [ ] OpenMeteoModel enum with 5 models
- [ ] MODEL_ENDPOINTS maps models to URLs
- [ ] provider_name returns model-specific name
- [ ] France uses Meteo-France endpoint
- [ ] Switzerland uses MeteoSwiss endpoint
- [ ] Italy uses DWD ICON endpoint
- [ ] NZ and ZA use best_match
- [ ] get_model_for_country helper works
- [ ] create_provider_for_country helper works
</success_criteria>

<output>
After completion, create `.planning/phases/06-international-weather/06-05-SUMMARY.md`
</output>
