---
phase: 06-international-weather
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - backend/app/services/weather/providers/envcanada.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Environment Canada provider fetches forecasts for Canadian coordinates"
    - "Environment Canada provider fetches weather alerts"
    - "Forecasts normalize to NormalizedDailyForecast format"
  artifacts:
    - path: "backend/app/services/weather/providers/envcanada.py"
      provides: "Environment Canada provider for Canadian weather"
      exports: ["EnvironmentCanadaProvider"]
  key_links:
    - from: "backend/app/services/weather/providers/envcanada.py"
      to: "backend/app/services/weather/base.py"
      via: "implements WeatherProvider ABC"
      pattern: "class EnvironmentCanadaProvider\\(WeatherProvider\\)"
---

<objective>
Implement Environment Canada provider for Canadian weather forecasts.

Purpose: Canada is a key hiking destination. Environment Canada provides free government data with alerts. This covers WTHR-02.

Output: EnvironmentCanadaProvider that fetches forecasts and alerts for Canadian coordinates.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-international-weather/06-CONTEXT.md
@.planning/phases/06-international-weather/06-RESEARCH.md
@.planning/phases/06-international-weather/06-01-SUMMARY.md
@backend/app/services/weather/base.py
@backend/app/services/weather/providers/openmeteo.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add env-canada dependency</name>
  <files>backend/requirements.txt</files>
  <action>
Add the env-canada package to requirements.txt.

The env-canada package provides a clean Python interface to Environment Canada data:
- Async support via update() method
- Provides forecasts, current conditions, alerts
- MIT licensed

Add to requirements.txt:
```
env-canada>=0.6.0
```

Install the dependency.
  </action>
  <verify>
```bash
cd /Users/andrewhall/thunderbird-web/backend
pip install env-canada>=0.6.0 && python -c "from env_canada import ECWeather; print('env-canada installed')"
```
  </verify>
  <done>env-canada package is installed and importable</done>
</task>

<task type="auto">
  <name>Task 2: Implement Environment Canada provider</name>
  <files>backend/app/services/weather/providers/envcanada.py</files>
  <action>
Create EnvironmentCanadaProvider implementing WeatherProvider ABC.

Use the env-canada library for cleaner API access:

```python
from env_canada import ECWeather

class EnvironmentCanadaProvider(WeatherProvider):
    @property
    def provider_name(self) -> str:
        return "Environment Canada"

    @property
    def supports_alerts(self) -> bool:
        return True

    async def get_forecast(self, lat: float, lon: float, days: int = 7) -> NormalizedDailyForecast:
        # ECWeather accepts coordinates
        weather = ECWeather(coordinates=(lat, lon))
        await weather.update()

        # Access weather.daily_forecasts for multi-day
        # Access weather.hourly_forecasts for hourly
        # Normalize to our format
        ...

    async def get_alerts(self, lat: float, lon: float) -> List[WeatherAlert]:
        weather = ECWeather(coordinates=(lat, lon))
        await weather.update()
        # Access weather.alerts
        ...
```

Normalization details:
1. ECWeather provides temperatures in Celsius (no conversion needed)
2. Wind speed in km/h (no conversion needed)
3. Precipitation in mm
4. Map EC alert structure to WeatherAlert

Handle edge cases:
- Coordinates outside Canada coverage
- API timeouts (EC can be slow)
- Missing data fields (use defaults)
  </action>
  <verify>
```bash
cd /Users/andrewhall/thunderbird-web/backend
python -c "
from app.services.weather.providers.envcanada import EnvironmentCanadaProvider
import asyncio

async def test():
    provider = EnvironmentCanadaProvider()
    # Test with Banff, Alberta (hiking destination)
    forecast = await provider.get_forecast(51.1784, -115.5708, days=3)
    print(f'Provider: {forecast.provider}')
    print(f'Periods: {len(forecast.periods)}')
    if forecast.periods:
        p = forecast.periods[0]
        print(f'First: {p.temp_min}C to {p.temp_max}C')
    assert forecast.provider == 'Environment Canada'
    print('EC forecast OK')

asyncio.run(test())
"
```
  </verify>
  <done>Environment Canada provider fetches and normalizes Canadian forecasts</done>
</task>

<task type="auto">
  <name>Task 3: Implement Environment Canada alerts</name>
  <files>backend/app/services/weather/providers/envcanada.py</files>
  <action>
Add alerts support to EnvironmentCanadaProvider.

The env-canada library provides alerts via weather.alerts property after update():
- Returns list of alert dictionaries
- Each alert has: title, type, event, and text

Map EC alert structure to WeatherAlert:
1. event = alert.get('title') or alert.get('event')
2. headline = alert.get('text', '')[:200] (truncate long text)
3. severity = map EC type to our severity levels:
   - 'warning' -> 'Severe'
   - 'watch' -> 'Moderate'
   - 'statement' -> 'Minor'
   - default -> 'Minor'
4. urgency = 'Expected' (EC doesn't provide this)
5. expires = None (EC format varies, parse if available)

Wrap alert fetching in try/except - don't fail if alerts unavailable.
  </action>
  <verify>
```bash
cd /Users/andrewhall/thunderbird-web/backend
python -c "
from app.services.weather.providers.envcanada import EnvironmentCanadaProvider
import asyncio

async def test():
    provider = EnvironmentCanadaProvider()
    assert provider.supports_alerts == True

    # Fetch alerts for Banff (may or may not have alerts)
    alerts = await provider.get_alerts(51.1784, -115.5708)
    print(f'Found {len(alerts)} alerts')
    for alert in alerts[:3]:
        print(f'  - {alert.event}: {alert.severity}')
    print('EC alerts OK')

asyncio.run(test())
"
```
  </verify>
  <done>Environment Canada alerts are fetched and converted to WeatherAlert format</done>
</task>

</tasks>

<verification>
After all tasks:
1. env-canada package installed
2. EnvironmentCanadaProvider implements WeatherProvider ABC
3. Forecasts fetch for Canadian coordinates (e.g., Banff)
4. Alerts fetch without failing
5. Provider correctly identifies as Environment Canada with alerts support
</verification>

<success_criteria>
- [ ] env-canada dependency added and installed
- [ ] EnvironmentCanadaProvider implements WeatherProvider ABC
- [ ] Forecasts normalized to NormalizedDailyForecast
- [ ] Alerts mapped to WeatherAlert format
- [ ] Errors handled gracefully
- [ ] supports_alerts returns True
</success_criteria>

<output>
After completion, create `.planning/phases/06-international-weather/06-03-SUMMARY.md`
</output>
