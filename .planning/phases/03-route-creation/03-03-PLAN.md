---
phase: 03-route-creation
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - package.json
  - app/create/page.tsx
  - app/components/map/MapEditor.tsx
  - app/components/map/RouteTrack.tsx
  - app/components/upload/GPXUpload.tsx
autonomous: true

must_haves:
  truths:
    - "User can see an interactive map on the create page"
    - "User can drag and drop GPX file to upload"
    - "Uploaded GPX track displays on the map"
    - "Map works on mobile with touch gestures"
  artifacts:
    - path: "app/create/page.tsx"
      provides: "Route creation page entry point"
      min_lines: 30
    - path: "app/components/map/MapEditor.tsx"
      provides: "Client-only map component with MapLibre"
      contains: "dynamic.*ssr.*false"
    - path: "app/components/upload/GPXUpload.tsx"
      provides: "Drag-drop GPX upload component"
      contains: "useDropzone"
  key_links:
    - from: "app/create/page.tsx"
      to: "app/components/map/MapEditor.tsx"
      via: "dynamic import"
      pattern: "dynamic.*import.*MapEditor"
    - from: "app/components/map/MapEditor.tsx"
      to: "maplibre-gl"
      via: "react-map-gl"
      pattern: "Map.*mapLib.*maplibre"
---

<objective>
Set up frontend map infrastructure with GPX upload and display.

Purpose: Enable users to upload GPX files and see their route on an interactive map - delivers ROUT-01, ROUT-02, ROUT-12.
Output: Working create page with MapLibre map, GPX drag-drop upload, and track visualization.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-route-creation/03-RESEARCH.md
@package.json
@app/layout.tsx
@tailwind.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install frontend map dependencies</name>
  <files>package.json</files>
  <action>
Install required packages for map and file upload:

```bash
cd /Users/andrewhall/thunderbird-web && npm install react-map-gl maplibre-gl @we-gold/gpxjs react-dropzone
```

This adds:
- react-map-gl: React wrapper for MapLibre
- maplibre-gl: Map rendering engine (free Mapbox fork)
- @we-gold/gpxjs: Client-side GPX parsing for preview
- react-dropzone: Drag-drop file upload

Also add types:
```bash
npm install --save-dev @types/mapbox__point-geometry
```
  </action>
  <verify>cd /Users/andrewhall/thunderbird-web && npm list react-map-gl maplibre-gl react-dropzone</verify>
  <done>All map dependencies installed, package.json updated</done>
</task>

<task type="auto">
  <name>Task 2: Create MapEditor component with SSR handling</name>
  <files>app/components/map/MapEditor.tsx, app/components/map/RouteTrack.tsx</files>
  <action>
Create the map editor component. CRITICAL: MapLibre cannot render server-side.

**MapEditor.tsx:**
```typescript
'use client';

import { useState, useCallback } from 'react';
import Map, { NavigationControl, MapLayerMouseEvent } from 'react-map-gl/maplibre';
import 'maplibre-gl/dist/maplibre-gl.css';
import RouteTrack from './RouteTrack';

interface MapEditorProps {
  trackGeojson?: GeoJSON.Feature;
  onMapClick?: (lat: number, lng: number) => void;
  initialViewport?: {
    latitude: number;
    longitude: number;
    zoom: number;
  };
}

export default function MapEditor({
  trackGeojson,
  onMapClick,
  initialViewport = { latitude: -42.0, longitude: 146.0, zoom: 8 }
}: MapEditorProps) {
  const [viewState, setViewState] = useState(initialViewport);

  const handleClick = useCallback((e: MapLayerMouseEvent) => {
    if (onMapClick) {
      onMapClick(e.lngLat.lat, e.lngLat.lng);
    }
  }, [onMapClick]);

  return (
    <div className="w-full h-[500px] md:h-[600px] rounded-lg overflow-hidden">
      <Map
        {...viewState}
        onMove={evt => setViewState(evt.viewState)}
        mapStyle="https://tiles.openfreemap.org/styles/liberty"
        onClick={handleClick}
        cooperativeGestures={true}
        attributionControl={true}
      >
        <NavigationControl position="top-right" />
        {trackGeojson && <RouteTrack geojson={trackGeojson} />}
      </Map>
    </div>
  );
}
```

**RouteTrack.tsx:**
```typescript
'use client';

import { Source, Layer } from 'react-map-gl/maplibre';

interface RouteTrackProps {
  geojson: GeoJSON.Feature;
}

export default function RouteTrack({ geojson }: RouteTrackProps) {
  return (
    <Source id="route-track" type="geojson" data={geojson}>
      <Layer
        id="route-line"
        type="line"
        paint={{
          'line-color': '#3b82f6',
          'line-width': 3,
          'line-opacity': 0.8
        }}
      />
    </Source>
  );
}
```

Key points:
- 'use client' directive for client-side rendering
- cooperativeGestures={true} prevents scroll hijacking on mobile (ROUT-12)
- OpenFreeMap tiles are free, no API key needed
- Attribution required for OpenStreetMap data
  </action>
  <verify>Test files exist and compile: npm run build (should not error on map components)</verify>
  <done>MapEditor renders MapLibre map, RouteTrack displays GeoJSON track, mobile-friendly gestures</done>
</task>

<task type="auto">
  <name>Task 3: Create GPXUpload component and create page</name>
  <files>app/components/upload/GPXUpload.tsx, app/create/page.tsx</files>
  <action>
**GPXUpload.tsx:**
```typescript
'use client';

import { useCallback } from 'react';
import { useDropzone } from 'react-dropzone';
import { Upload } from 'lucide-react';

interface GPXUploadProps {
  onUpload: (file: File) => void;
  isLoading?: boolean;
}

export default function GPXUpload({ onUpload, isLoading }: GPXUploadProps) {
  const onDrop = useCallback((acceptedFiles: File[]) => {
    if (acceptedFiles[0]) {
      onUpload(acceptedFiles[0]);
    }
  }, [onUpload]);

  const { getRootProps, getInputProps, isDragActive } = useDropzone({
    accept: {
      'application/gpx+xml': ['.gpx'],
      'application/xml': ['.gpx'],
      'text/xml': ['.gpx']
    },
    maxFiles: 1,
    onDrop,
    disabled: isLoading
  });

  return (
    <div
      {...getRootProps()}
      className={`
        border-2 border-dashed rounded-lg p-8 text-center cursor-pointer
        transition-colors duration-200
        ${isDragActive
          ? 'border-blue-400 bg-blue-400/10'
          : 'border-gray-600 hover:border-gray-500'}
        ${isLoading ? 'opacity-50 cursor-not-allowed' : ''}
      `}
    >
      <input {...getInputProps()} />
      <Upload className="w-12 h-12 mx-auto mb-4 text-gray-400" />
      {isDragActive ? (
        <p className="text-blue-400">Drop your GPX file here...</p>
      ) : (
        <>
          <p className="text-gray-300 mb-2">
            Drag & drop a GPX file, or click to select
          </p>
          <p className="text-sm text-gray-500">
            Export from Gaia GPS, AllTrails, Caltopo, or your GPS device
          </p>
        </>
      )}
    </div>
  );
}
```

**app/create/page.tsx:**
```typescript
'use client';

import { useState } from 'react';
import dynamic from 'next/dynamic';
import GPXUpload from '../components/upload/GPXUpload';
import { parseGPX } from '@we-gold/gpxjs';

// Dynamic import to avoid SSR issues with MapLibre
const MapEditor = dynamic(() => import('../components/map/MapEditor'), {
  ssr: false,
  loading: () => (
    <div className="w-full h-[500px] md:h-[600px] bg-gray-900 rounded-lg animate-pulse flex items-center justify-center">
      <p className="text-gray-500">Loading map...</p>
    </div>
  )
});

export default function CreateRoutePage() {
  const [trackGeojson, setTrackGeojson] = useState<GeoJSON.Feature | null>(null);
  const [routeName, setRouteName] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleGPXUpload = async (file: File) => {
    setIsLoading(true);
    setError(null);

    try {
      const text = await file.text();
      const [result, err] = parseGPX(text);

      if (err) {
        throw new Error('Failed to parse GPX file');
      }

      // Convert to GeoJSON
      const geojson = result.toGeoJSON();

      // Find the track feature
      const track = geojson.features.find(
        (f: GeoJSON.Feature) => f.geometry.type === 'LineString' || f.geometry.type === 'MultiLineString'
      );

      if (track) {
        setTrackGeojson(track);
        // Set default route name from GPX metadata or filename
        setRouteName(result.metadata?.name || file.name.replace('.gpx', ''));
      } else {
        setError('No track found in GPX file');
      }
    } catch (e) {
      setError('Failed to parse GPX file. Please check the format.');
      console.error(e);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gray-950 text-white">
      <div className="max-w-6xl mx-auto px-4 py-8">
        <h1 className="text-3xl font-bold mb-2">Create Your Route</h1>
        <p className="text-gray-400 mb-8">
          Upload a GPX file from your favorite hiking app, then add waypoints for weather forecasts.
        </p>

        {!trackGeojson && (
          <GPXUpload onUpload={handleGPXUpload} isLoading={isLoading} />
        )}

        {error && (
          <div className="mt-4 p-4 bg-red-900/50 border border-red-500 rounded-lg text-red-200">
            {error}
          </div>
        )}

        {trackGeojson && (
          <div className="mt-6 space-y-6">
            <div>
              <label className="block text-sm font-medium text-gray-300 mb-2">
                Route Name
              </label>
              <input
                type="text"
                value={routeName}
                onChange={(e) => setRouteName(e.target.value)}
                className="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-blue-500"
                placeholder="My Awesome Hike"
              />
            </div>

            <div>
              <h2 className="text-xl font-semibold mb-4">Your Route</h2>
              <MapEditor trackGeojson={trackGeojson} />
            </div>

            <p className="text-gray-400 text-sm">
              Click on the map to add waypoints. Coming next: waypoint editor.
            </p>
          </div>
        )}
      </div>
    </div>
  );
}
```

Create directories first:
```bash
mkdir -p app/components/map app/components/upload app/create
```

Key points:
- Dynamic import with ssr: false prevents MapLibre SSR errors
- Client-side GPX parsing for instant preview (backend validation on save)
- Mobile-responsive layout with Tailwind
  </action>
  <verify>cd /Users/andrewhall/thunderbird-web && npm run build && npm run dev (then visit http://localhost:3000/create)</verify>
  <done>Create page loads, GPX upload works, track displays on map, mobile responsive</done>
</task>

</tasks>

<verification>
1. Page loads at /create without errors
2. GPX drag-drop zone visible and functional
3. After upload, track appears on map as blue line
4. Map is interactive (pan, zoom)
5. On mobile: two-finger pan/zoom works, single finger doesn't hijack scroll
6. No SSR errors in console
</verification>

<success_criteria>
- ROUT-01: GPX upload functional with drag-drop
- ROUT-02: Uploaded track displays on interactive map
- ROUT-12: Mobile responsive with cooperative gestures
- No hydration errors or SSR crashes
- Map tiles load from OpenFreeMap
</success_criteria>

<output>
After completion, create `.planning/phases/03-route-creation/03-03-SUMMARY.md`
</output>
