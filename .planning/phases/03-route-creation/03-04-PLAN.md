---
phase: 03-route-creation
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - app/components/map/WaypointMarker.tsx
  - app/components/waypoint/WaypointEditor.tsx
  - app/components/waypoint/WaypointList.tsx
  - app/components/map/MapEditor.tsx
  - app/create/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can click map to add waypoint pins"
    - "Three pin types available with distinct colors: camp (green), peak (orange), POI (blue)"
    - "User can name each waypoint"
    - "System auto-generates SMS code from waypoint name"
    - "User can drag waypoints to reposition"
    - "User can delete waypoints"
  artifacts:
    - path: "app/components/map/WaypointMarker.tsx"
      provides: "Color-coded draggable waypoint marker"
      contains: "draggable.*onDragEnd"
    - path: "app/components/waypoint/WaypointEditor.tsx"
      provides: "Form to edit waypoint name and type"
      exports: ["WaypointEditor"]
    - path: "app/components/waypoint/WaypointList.tsx"
      provides: "Sidebar list of all waypoints"
      exports: ["WaypointList"]
  key_links:
    - from: "app/components/map/MapEditor.tsx"
      to: "app/components/map/WaypointMarker.tsx"
      via: "Marker component"
      pattern: "waypoints\\.map.*WaypointMarker"
    - from: "app/create/page.tsx"
      to: "/api/routes"
      via: "fetch POST for save"
      pattern: "fetch.*api/routes"
---

<objective>
Implement waypoint creation, editing, and management in the map editor.

Purpose: Enable users to add, edit, drag, and delete waypoints with auto-generated SMS codes - delivers ROUT-03 through ROUT-08.
Output: Full waypoint editing UI with map markers, sidebar list, and backend integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-route-creation/03-RESEARCH.md
@.planning/phases/03-route-creation/03-02-SUMMARY.md
@.planning/phases/03-route-creation/03-03-SUMMARY.md
@app/components/map/MapEditor.tsx
@app/create/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WaypointMarker component with drag support</name>
  <files>app/components/map/WaypointMarker.tsx</files>
  <action>
Create color-coded draggable waypoint marker per ROUT-04, ROUT-07.

```typescript
'use client';

import { Marker, MarkerDragEvent } from 'react-map-gl/maplibre';

// Color scheme per ROUT-04
const WAYPOINT_COLORS = {
  camp: '#22c55e',   // Green
  peak: '#f97316',   // Orange
  poi: '#3b82f6'     // Blue
} as const;

const WAYPOINT_ICONS = {
  camp: 'tent',    // Tent icon
  peak: 'mountain', // Mountain icon
  poi: 'map-pin'   // Generic pin
} as const;

export type WaypointType = keyof typeof WAYPOINT_COLORS;

export interface Waypoint {
  id: string;
  lat: number;
  lng: number;
  name: string;
  type: WaypointType;
  smsCode: string;
  elevation?: number;
}

interface WaypointMarkerProps {
  waypoint: Waypoint;
  isSelected?: boolean;
  onSelect?: (id: string) => void;
  onDragEnd?: (id: string, lat: number, lng: number) => void;
  onDelete?: (id: string) => void;
}

export default function WaypointMarker({
  waypoint,
  isSelected,
  onSelect,
  onDragEnd,
  onDelete
}: WaypointMarkerProps) {
  const handleDragEnd = (e: MarkerDragEvent) => {
    if (onDragEnd) {
      onDragEnd(waypoint.id, e.lngLat.lat, e.lngLat.lng);
    }
  };

  const handleClick = (e: React.MouseEvent) => {
    e.stopPropagation();
    if (onSelect) {
      onSelect(waypoint.id);
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Delete' || e.key === 'Backspace') {
      if (onDelete) {
        onDelete(waypoint.id);
      }
    }
  };

  return (
    <Marker
      latitude={waypoint.lat}
      longitude={waypoint.lng}
      draggable
      onDragEnd={handleDragEnd}
      anchor="bottom"
    >
      <div
        onClick={handleClick}
        onKeyDown={handleKeyDown}
        tabIndex={0}
        className={`
          flex flex-col items-center cursor-pointer
          transition-transform duration-150
          ${isSelected ? 'scale-125 z-10' : 'hover:scale-110'}
        `}
        role="button"
        aria-label={`${waypoint.name} - ${waypoint.type}`}
      >
        {/* Pin */}
        <div
          className={`
            flex items-center justify-center
            w-8 h-8 rounded-full
            text-xs font-bold text-white
            shadow-lg
            ${isSelected ? 'ring-2 ring-white ring-offset-2 ring-offset-gray-900' : ''}
          `}
          style={{ backgroundColor: WAYPOINT_COLORS[waypoint.type] }}
        >
          {waypoint.smsCode.slice(0, 3)}
        </div>
        {/* Stem */}
        <div
          className="w-0.5 h-2"
          style={{ backgroundColor: WAYPOINT_COLORS[waypoint.type] }}
        />
        {/* Label (visible when selected) */}
        {isSelected && (
          <div className="mt-1 px-2 py-0.5 bg-gray-900/90 rounded text-xs text-white whitespace-nowrap">
            {waypoint.name}
          </div>
        )}
      </div>
    </Marker>
  );
}
```

Key features:
- Color-coded by type (green/orange/blue per ROUT-04)
- Shows first 3 chars of SMS code in pin
- Draggable for repositioning (ROUT-07)
- Click to select, Delete key to remove (ROUT-08)
- Selected state shows full name and ring highlight
  </action>
  <verify>Import and render test: component compiles without errors</verify>
  <done>WaypointMarker renders with correct colors, is draggable, shows selection state</done>
</task>

<task type="auto">
  <name>Task 2: Create WaypointEditor and WaypointList components</name>
  <files>app/components/waypoint/WaypointEditor.tsx, app/components/waypoint/WaypointList.tsx</files>
  <action>
**WaypointEditor.tsx** - Edit selected waypoint details (ROUT-05, ROUT-06):

```typescript
'use client';

import { useState, useEffect } from 'react';
import { Waypoint, WaypointType } from '../map/WaypointMarker';
import { Trash2, MapPin, Mountain, Tent } from 'lucide-react';

interface WaypointEditorProps {
  waypoint: Waypoint | null;
  onUpdate: (id: string, updates: Partial<Waypoint>) => void;
  onDelete: (id: string) => void;
  onClose: () => void;
}

const TYPE_OPTIONS: { value: WaypointType; label: string; icon: typeof MapPin }[] = [
  { value: 'camp', label: 'Camp', icon: Tent },
  { value: 'peak', label: 'Peak', icon: Mountain },
  { value: 'poi', label: 'Point of Interest', icon: MapPin }
];

export default function WaypointEditor({
  waypoint,
  onUpdate,
  onDelete,
  onClose
}: WaypointEditorProps) {
  const [name, setName] = useState('');
  const [type, setType] = useState<WaypointType>('poi');

  useEffect(() => {
    if (waypoint) {
      setName(waypoint.name);
      setType(waypoint.type);
    }
  }, [waypoint]);

  if (!waypoint) return null;

  const handleNameChange = (newName: string) => {
    setName(newName);
    onUpdate(waypoint.id, { name: newName });
  };

  const handleTypeChange = (newType: WaypointType) => {
    setType(newType);
    onUpdate(waypoint.id, { type: newType });
  };

  return (
    <div className="bg-gray-800 rounded-lg p-4 space-y-4">
      <div className="flex items-center justify-between">
        <h3 className="text-lg font-semibold text-white">Edit Waypoint</h3>
        <button
          onClick={onClose}
          className="text-gray-400 hover:text-white"
        >
          &times;
        </button>
      </div>

      {/* Name input */}
      <div>
        <label className="block text-sm font-medium text-gray-300 mb-1">
          Name
        </label>
        <input
          type="text"
          value={name}
          onChange={(e) => handleNameChange(e.target.value)}
          className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-blue-500"
          placeholder="e.g., Lake Oberon Camp"
        />
      </div>

      {/* SMS Code display (auto-generated, ROUT-06) */}
      <div>
        <label className="block text-sm font-medium text-gray-300 mb-1">
          SMS Code
        </label>
        <div className="flex items-center gap-2">
          <code className="px-3 py-2 bg-gray-900 rounded-lg text-blue-400 font-mono text-lg">
            {waypoint.smsCode}
          </code>
          <span className="text-sm text-gray-500">
            Auto-generated from name
          </span>
        </div>
      </div>

      {/* Type selector */}
      <div>
        <label className="block text-sm font-medium text-gray-300 mb-2">
          Type
        </label>
        <div className="grid grid-cols-3 gap-2">
          {TYPE_OPTIONS.map(({ value, label, icon: Icon }) => (
            <button
              key={value}
              onClick={() => handleTypeChange(value)}
              className={`
                flex flex-col items-center gap-1 p-3 rounded-lg border transition-colors
                ${type === value
                  ? 'border-blue-500 bg-blue-500/20 text-blue-400'
                  : 'border-gray-600 bg-gray-700 text-gray-300 hover:border-gray-500'}
              `}
            >
              <Icon className="w-5 h-5" />
              <span className="text-xs">{label}</span>
            </button>
          ))}
        </div>
      </div>

      {/* Coordinates (read-only) */}
      <div className="text-sm text-gray-400">
        <p>Lat: {waypoint.lat.toFixed(5)}</p>
        <p>Lng: {waypoint.lng.toFixed(5)}</p>
        {waypoint.elevation && <p>Elevation: {waypoint.elevation}m</p>}
      </div>

      {/* Delete button */}
      <button
        onClick={() => onDelete(waypoint.id)}
        className="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-600/20 text-red-400 rounded-lg hover:bg-red-600/30 transition-colors"
      >
        <Trash2 className="w-4 h-4" />
        Delete Waypoint
      </button>
    </div>
  );
}
```

**WaypointList.tsx** - Sidebar list showing all waypoints:

```typescript
'use client';

import { Waypoint, WaypointType } from '../map/WaypointMarker';
import { Tent, Mountain, MapPin, GripVertical } from 'lucide-react';

interface WaypointListProps {
  waypoints: Waypoint[];
  selectedId: string | null;
  onSelect: (id: string) => void;
  onReorder?: (startIndex: number, endIndex: number) => void;
}

const TYPE_ICONS = {
  camp: Tent,
  peak: Mountain,
  poi: MapPin
};

const TYPE_COLORS = {
  camp: 'text-green-400',
  peak: 'text-orange-400',
  poi: 'text-blue-400'
};

export default function WaypointList({
  waypoints,
  selectedId,
  onSelect
}: WaypointListProps) {
  if (waypoints.length === 0) {
    return (
      <div className="text-center py-8 text-gray-500">
        <MapPin className="w-8 h-8 mx-auto mb-2 opacity-50" />
        <p>No waypoints yet</p>
        <p className="text-sm">Click on the map to add one</p>
      </div>
    );
  }

  return (
    <div className="space-y-2">
      <h3 className="text-sm font-medium text-gray-400 uppercase tracking-wider">
        Waypoints ({waypoints.length})
      </h3>
      <ul className="space-y-1">
        {waypoints.map((wp) => {
          const Icon = TYPE_ICONS[wp.type];
          return (
            <li key={wp.id}>
              <button
                onClick={() => onSelect(wp.id)}
                className={`
                  w-full flex items-center gap-3 px-3 py-2 rounded-lg text-left
                  transition-colors
                  ${selectedId === wp.id
                    ? 'bg-blue-500/20 border border-blue-500/50'
                    : 'hover:bg-gray-700/50'}
                `}
              >
                <GripVertical className="w-4 h-4 text-gray-600 cursor-grab" />
                <Icon className={`w-5 h-5 ${TYPE_COLORS[wp.type]}`} />
                <div className="flex-1 min-w-0">
                  <p className="text-white truncate">
                    {wp.name || 'Unnamed waypoint'}
                  </p>
                  <p className="text-xs text-gray-500">
                    <code className="text-blue-400">{wp.smsCode}</code>
                    {' '}&middot;{' '}
                    {wp.lat.toFixed(3)}, {wp.lng.toFixed(3)}
                  </p>
                </div>
              </button>
            </li>
          );
        })}
      </ul>
    </div>
  );
}
```

Create directory first:
```bash
mkdir -p app/components/waypoint
```
  </action>
  <verify>Components compile without errors</verify>
  <done>WaypointEditor allows name/type editing, shows SMS code. WaypointList shows all waypoints.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate waypoint management into create page</name>
  <files>app/components/map/MapEditor.tsx, app/create/page.tsx</files>
  <action>
Update MapEditor to handle waypoints and integrate everything in the create page.

**Update MapEditor.tsx** to accept waypoints and render markers:

```typescript
// Add to imports
import WaypointMarker, { Waypoint } from './WaypointMarker';

// Update props interface
interface MapEditorProps {
  trackGeojson?: GeoJSON.Feature;
  waypoints?: Waypoint[];
  selectedWaypointId?: string | null;
  onMapClick?: (lat: number, lng: number) => void;
  onWaypointSelect?: (id: string) => void;
  onWaypointDrag?: (id: string, lat: number, lng: number) => void;
  onWaypointDelete?: (id: string) => void;
  initialViewport?: { latitude: number; longitude: number; zoom: number };
}

// Inside Map component, render waypoints:
{waypoints?.map((wp) => (
  <WaypointMarker
    key={wp.id}
    waypoint={wp}
    isSelected={selectedWaypointId === wp.id}
    onSelect={onWaypointSelect}
    onDragEnd={onWaypointDrag}
    onDelete={onWaypointDelete}
  />
))}
```

**Update app/create/page.tsx** for full waypoint workflow:

Add state management:
```typescript
const [waypoints, setWaypoints] = useState<Waypoint[]>([]);
const [selectedWaypointId, setSelectedWaypointId] = useState<string | null>(null);

// SMS code generation (client-side preview)
function generateSMSCode(name: string, existingCodes: string[]): string {
  const cleaned = name.replace(/^(Mt\.?|Mount|Lake|The|Camp|Point|Peak)\s+/i, '')
    .replace(/[^A-Za-z]/g, '').toUpperCase();
  let code = cleaned.slice(0, 5).padEnd(5, 'X');

  let suffix = 1;
  while (existingCodes.includes(code)) {
    code = cleaned.slice(0, 4) + suffix;
    suffix++;
  }
  return code;
}

const handleMapClick = (lat: number, lng: number) => {
  const existingCodes = waypoints.map(w => w.smsCode);
  const defaultName = `Waypoint ${waypoints.length + 1}`;
  const newWaypoint: Waypoint = {
    id: crypto.randomUUID(),
    lat,
    lng,
    name: defaultName,
    type: 'poi',
    smsCode: generateSMSCode(defaultName, existingCodes)
  };
  setWaypoints([...waypoints, newWaypoint]);
  setSelectedWaypointId(newWaypoint.id);
};

const handleWaypointUpdate = (id: string, updates: Partial<Waypoint>) => {
  setWaypoints(waypoints.map(wp => {
    if (wp.id !== id) return wp;
    const updated = { ...wp, ...updates };
    // Regenerate SMS code if name changed
    if (updates.name && updates.name !== wp.name) {
      const existingCodes = waypoints.filter(w => w.id !== id).map(w => w.smsCode);
      updated.smsCode = generateSMSCode(updates.name, existingCodes);
    }
    return updated;
  }));
};

const handleWaypointDrag = (id: string, lat: number, lng: number) => {
  setWaypoints(waypoints.map(wp =>
    wp.id === id ? { ...wp, lat, lng } : wp
  ));
};

const handleWaypointDelete = (id: string) => {
  setWaypoints(waypoints.filter(wp => wp.id !== id));
  if (selectedWaypointId === id) {
    setSelectedWaypointId(null);
  }
};
```

Layout with sidebar:
```typescript
{trackGeojson && (
  <div className="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    {/* Map takes 2 columns on large screens */}
    <div className="lg:col-span-2">
      <MapEditor
        trackGeojson={trackGeojson}
        waypoints={waypoints}
        selectedWaypointId={selectedWaypointId}
        onMapClick={handleMapClick}
        onWaypointSelect={setSelectedWaypointId}
        onWaypointDrag={handleWaypointDrag}
        onWaypointDelete={handleWaypointDelete}
      />
      <p className="mt-2 text-sm text-gray-500">
        Click on the map to add waypoints. Drag to reposition.
      </p>
    </div>

    {/* Sidebar */}
    <div className="space-y-6">
      <WaypointList
        waypoints={waypoints}
        selectedId={selectedWaypointId}
        onSelect={setSelectedWaypointId}
      />

      <WaypointEditor
        waypoint={waypoints.find(w => w.id === selectedWaypointId) || null}
        onUpdate={handleWaypointUpdate}
        onDelete={handleWaypointDelete}
        onClose={() => setSelectedWaypointId(null)}
      />
    </div>
  </div>
)}
```

Add imports at top:
```typescript
import WaypointList from '../components/waypoint/WaypointList';
import WaypointEditor from '../components/waypoint/WaypointEditor';
import { Waypoint } from '../components/map/WaypointMarker';
```
  </action>
  <verify>npm run dev, visit /create, upload GPX, click map to add waypoints, drag to move, edit in sidebar, delete works</verify>
  <done>Full waypoint management: click-to-add, drag-to-move, edit name/type, auto SMS code, delete</done>
</task>

</tasks>

<verification>
1. Click on map adds waypoint with pin
2. Three pin colors: green (camp), orange (peak), blue (POI)
3. Changing waypoint name updates SMS code automatically
4. Drag waypoint updates its position
5. Delete waypoint removes from map and list
6. Sidebar list shows all waypoints with icons
7. Selecting waypoint highlights it on map
</verification>

<success_criteria>
- ROUT-03: Click map to add waypoint pins
- ROUT-04: Three pin types with correct colors
- ROUT-05: User can name each waypoint
- ROUT-06: SMS code auto-generates from name
- ROUT-07: Drag waypoints to reposition
- ROUT-08: Delete waypoints works
</success_criteria>

<output>
After completion, create `.planning/phases/03-route-creation/03-04-SUMMARY.md`
</output>
