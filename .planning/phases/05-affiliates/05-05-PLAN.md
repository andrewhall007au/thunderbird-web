---
phase: 05-affiliates
plan: 05
type: execute
wave: 5
depends_on: ["05-03", "05-04"]
files_modified:
  - backend/app/routers/admin.py
  - backend/app/routers/affiliates.py
  - backend/app/services/affiliates.py
  - backend/app/services/email.py
autonomous: true

must_haves:
  truths:
    - "Affiliates can request payout when available balance >= $50"
    - "Admin can view pending payout requests"
    - "Admin can mark payouts as paid"
    - "Commission status transitions: pending -> available -> requested -> paid"
    - "Milestone email alerts sent when affiliates hit thresholds"
  artifacts:
    - path: "backend/app/routers/affiliates.py"
      provides: "Payout request endpoint"
      contains: "request_payout"
    - path: "backend/app/routers/admin.py"
      provides: "Admin payout management"
      contains: "payouts"
  key_links:
    - from: "backend/app/routers/affiliates.py"
      to: "backend/app/services/affiliates.py"
      via: "request_payout() method"
      pattern: "affiliate_service\\.request_payout"
    - from: "backend/app/services/affiliates.py"
      to: "backend/app/services/email.py"
      via: "send_milestone_email() on threshold hit"
      pattern: "send_milestone_email"
---

<objective>
Implement payout tracking and milestone email alerts.

Purpose: Complete AFFL-07 (commission payout tracking) and milestone alerts from CONTEXT.md. Affiliates need to request payouts, admin needs to process them manually.

Output: Payout request flow, admin payout management UI, and milestone email triggers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-affiliates/05-CONTEXT.md
@.planning/phases/05-affiliates/05-RESEARCH.md

# Prior plan context
@.planning/phases/05-affiliates/05-01-SUMMARY.md
@.planning/phases/05-affiliates/05-02-SUMMARY.md
@.planning/phases/05-affiliates/05-03-SUMMARY.md
@.planning/phases/05-affiliates/05-04-SUMMARY.md

# Email pattern
@backend/app/services/email.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add payout methods to AffiliateService</name>
  <files>backend/app/services/affiliates.py</files>
  <action>
Add payout management methods to `backend/app/services/affiliates.py`:

```python
from dataclasses import dataclass
from typing import Optional, List

PAYOUT_MINIMUM_CENTS = 5000  # $50 minimum from CONTEXT.md
MILESTONE_THRESHOLDS = [5000, 10000, 50000, 100000]  # $50, $100, $500, $1000


@dataclass
class PayoutRequest:
    """Payout request details."""
    affiliate_id: int
    affiliate_code: str
    affiliate_name: str
    affiliate_email: str
    amount_cents: int
    payout_method: Optional[str]
    payout_details: Optional[str]
    request_date: str


class AffiliateService:
    # ... existing methods ...

    def request_payout(self, affiliate_id: int) -> tuple[bool, str]:
        """
        Request payout for available commissions.

        From CONTEXT.md:
        - $50 minimum threshold
        - Manual approval required
        - Commission states: Available -> Requested

        Args:
            affiliate_id: Affiliate requesting payout

        Returns:
            (success, message) tuple
        """
        affiliate = affiliate_store.get_by_id(affiliate_id)
        if not affiliate:
            return False, "Affiliate not found"

        if not affiliate.active:
            return False, "Affiliate account inactive"

        # Check available balance
        available_commissions = commission_store.get_by_status(
            affiliate_id, "available"
        )
        available_cents = sum(c.amount_cents for c in available_commissions)

        if available_cents < PAYOUT_MINIMUM_CENTS:
            return False, f"Minimum payout is ${PAYOUT_MINIMUM_CENTS/100:.2f}. Current available: ${available_cents/100:.2f}"

        if not affiliate.payout_method:
            return False, "Please set your payout method first"

        # Mark all available commissions as requested
        for commission in available_commissions:
            commission_store.update_status(commission.id, "requested")

        logger.info(f"Payout requested: ${available_cents/100:.2f} for affiliate {affiliate.code}")

        return True, f"Payout of ${available_cents/100:.2f} requested. Admin will process within 5 business days."

    def get_pending_payouts(self) -> List[PayoutRequest]:
        """
        Get all pending payout requests for admin review.

        Returns:
            List of PayoutRequest objects
        """
        # Get all affiliates with "requested" status commissions
        affiliates = affiliate_store.list_all()
        pending = []

        for affiliate in affiliates:
            requested = commission_store.get_by_status(affiliate.id, "requested")
            if requested:
                amount = sum(c.amount_cents for c in requested)
                earliest_request = min(c.created_at for c in requested if c.created_at)

                pending.append(PayoutRequest(
                    affiliate_id=affiliate.id,
                    affiliate_code=affiliate.code,
                    affiliate_name=affiliate.name,
                    affiliate_email=affiliate.email,
                    amount_cents=amount,
                    payout_method=affiliate.payout_method,
                    payout_details=affiliate.payout_details,
                    request_date=earliest_request.isoformat() if earliest_request else "Unknown"
                ))

        return sorted(pending, key=lambda p: p.request_date)

    def process_payout(self, affiliate_id: int) -> tuple[bool, str]:
        """
        Mark payout as processed (admin action).

        Args:
            affiliate_id: Affiliate whose payout was processed

        Returns:
            (success, message) tuple
        """
        requested = commission_store.get_by_status(affiliate_id, "requested")
        if not requested:
            return False, "No pending payout request"

        amount = sum(c.amount_cents for c in requested)

        # Mark all as paid
        now = datetime.utcnow()
        for commission in requested:
            commission_store.update_status(commission.id, "paid", paid_at=now.isoformat())

        affiliate = affiliate_store.get_by_id(affiliate_id)
        logger.info(f"Payout processed: ${amount/100:.2f} for affiliate {affiliate.code if affiliate else affiliate_id}")

        return True, f"Payout of ${amount/100:.2f} marked as paid"

    def update_payout_method(
        self,
        affiliate_id: int,
        payout_method: str,
        payout_details: str
    ) -> bool:
        """
        Update affiliate's payout method.

        Args:
            affiliate_id: Affiliate ID
            payout_method: "paypal" or "bank"
            payout_details: PayPal email or bank details

        Returns:
            True if updated
        """
        return affiliate_store.update_payout_info(
            affiliate_id, payout_method, payout_details
        )

    def check_milestones(self, affiliate_id: int) -> Optional[int]:
        """
        Check if affiliate hit a new milestone.

        From CONTEXT.md: Milestone email alerts at thresholds.
        Thresholds: $50, $100, $500, $1000

        Args:
            affiliate_id: Affiliate to check

        Returns:
            Milestone amount if new milestone hit, None otherwise
        """
        affiliate = affiliate_store.get_by_id(affiliate_id)
        if not affiliate:
            return None

        # Get total lifetime earnings (paid + available + requested)
        commissions = commission_store.get_by_affiliate_id(affiliate_id)
        total_cents = sum(
            c.amount_cents for c in commissions
            if c.status in ("pending", "available", "requested", "paid")
        )

        # Check each threshold
        # We need to track which milestones have been notified
        # For now, store last_milestone_cents on affiliate
        last_milestone = getattr(affiliate, 'last_milestone_cents', 0) or 0

        for threshold in MILESTONE_THRESHOLDS:
            if total_cents >= threshold > last_milestone:
                # New milestone hit!
                affiliate_store.update_last_milestone(affiliate_id, threshold)
                return threshold

        return None

    async def send_milestone_email(self, affiliate_id: int, milestone_cents: int):
        """
        Send milestone celebration email.

        Args:
            affiliate_id: Affiliate who hit milestone
            milestone_cents: Milestone amount in cents
        """
        affiliate = affiliate_store.get_by_id(affiliate_id)
        if not affiliate or not affiliate.email:
            return

        from app.services.email import send_affiliate_milestone_email
        await send_affiliate_milestone_email(
            to_email=affiliate.email,
            affiliate_name=affiliate.name,
            milestone_amount=f"${milestone_cents/100:.0f}"
        )
```

Also add:
- `get_by_status()` method to CommissionStore
- `update_payout_info()` and `update_last_milestone()` methods to AffiliateStore
- `last_milestone_cents` field to Affiliate model (migration needed)
  </action>
  <verify>
    python -c "from backend.app.services.affiliates import get_affiliate_service; svc = get_affiliate_service(); print(hasattr(svc, 'request_payout'))"
  </verify>
  <done>AffiliateService has request_payout(), get_pending_payouts(), process_payout(), check_milestones(), send_milestone_email() methods</done>
</task>

<task type="auto">
  <name>Task 2: Add payout endpoints to affiliate router</name>
  <files>backend/app/routers/affiliates.py</files>
  <action>
Add payout endpoints to `backend/app/routers/affiliates.py`:

```python
from pydantic import BaseModel, EmailStr


class PayoutMethodRequest(BaseModel):
    """Request to update payout method."""
    payout_method: str  # "paypal" or "bank"
    payout_details: str  # PayPal email or bank info


class PayoutRequestResponse(BaseModel):
    """Response for payout request."""
    success: bool
    message: str
    amount_requested: Optional[str] = None


@router.post("/payout/method/{affiliate_code}")
async def update_payout_method(
    affiliate_code: str,
    request: PayoutMethodRequest
):
    """
    Update affiliate's payout method.

    Must be set before requesting payout.
    """
    affiliate = affiliate_store.get_by_code(affiliate_code.upper())
    if not affiliate:
        raise HTTPException(status_code=404, detail="Affiliate not found")

    if request.payout_method not in ("paypal", "bank"):
        raise HTTPException(status_code=400, detail="Invalid payout method. Use 'paypal' or 'bank'")

    affiliate_service = get_affiliate_service()
    success = affiliate_service.update_payout_method(
        affiliate.id,
        request.payout_method,
        request.payout_details
    )

    if not success:
        raise HTTPException(status_code=500, detail="Failed to update payout method")

    return {"success": True, "message": "Payout method updated"}


@router.post("/payout/request/{affiliate_code}", response_model=PayoutRequestResponse)
async def request_payout(affiliate_code: str):
    """
    Request payout of available commission.

    From CONTEXT.md:
    - $50 minimum threshold
    - Manual approval by admin
    - PayPal or bank transfer

    Returns:
        Success status and message
    """
    affiliate = affiliate_store.get_by_code(affiliate_code.upper())
    if not affiliate:
        raise HTTPException(status_code=404, detail="Affiliate not found")

    affiliate_service = get_affiliate_service()
    success, message = affiliate_service.request_payout(affiliate.id)

    if not success:
        return PayoutRequestResponse(success=False, message=message)

    # Get amount for response
    stats = affiliate_service.get_affiliate_stats(affiliate.id, "all")
    requested_amount = f"${stats.requested_cents/100:.2f}" if stats else "Unknown"

    return PayoutRequestResponse(
        success=True,
        message=message,
        amount_requested=requested_amount
    )


@router.get("/payout/status/{affiliate_code}")
async def get_payout_status(affiliate_code: str):
    """
    Get current payout status and history.
    """
    affiliate = affiliate_store.get_by_code(affiliate_code.upper())
    if not affiliate:
        raise HTTPException(status_code=404, detail="Affiliate not found")

    affiliate_service = get_affiliate_service()
    stats = affiliate_service.get_affiliate_stats(affiliate.id, "all")

    return {
        "affiliate_code": affiliate.code,
        "payout_method": affiliate.payout_method,
        "payout_details_set": bool(affiliate.payout_details),
        "available_cents": stats.available_cents if stats else 0,
        "available": f"${(stats.available_cents if stats else 0)/100:.2f}",
        "requested_cents": stats.requested_cents if stats else 0,
        "requested": f"${(stats.requested_cents if stats else 0)/100:.2f}",
        "paid_cents": stats.paid_cents if stats else 0,
        "paid": f"${(stats.paid_cents if stats else 0)/100:.2f}",
        "can_request_payout": (stats.available_cents if stats else 0) >= 5000,
        "minimum_payout": "$50.00"
    }
```
  </action>
  <verify>
    grep -n "request_payout" backend/app/routers/affiliates.py
  </verify>
  <done>Affiliate router has /payout/method/{code}, /payout/request/{code}, /payout/status/{code} endpoints</done>
</task>

<task type="auto">
  <name>Task 3: Add admin payout management and milestone emails</name>
  <files>backend/app/routers/admin.py, backend/app/services/email.py</files>
  <action>
1. **Add payout management routes to admin.py:**

```python
@router.get("/payouts", response_class=HTMLResponse)
async def admin_payouts(request: Request):
    """Admin payout management page. AFFL-07."""
    if not require_admin(request):
        return RedirectResponse("/admin/login", status_code=302)

    from app.services.affiliates import get_affiliate_service
    affiliate_service = get_affiliate_service()
    pending_payouts = affiliate_service.get_pending_payouts()

    message = request.query_params.get("msg", "")
    return render_payout_admin(pending_payouts, message)


@router.post("/payouts/{affiliate_id}/process")
async def admin_process_payout(affiliate_id: int, request: Request):
    """
    Mark payout as processed.

    Admin has manually sent money via PayPal or bank transfer.
    """
    if not require_admin(request):
        return RedirectResponse("/admin/login", status_code=302)

    from app.services.affiliates import get_affiliate_service
    affiliate_service = get_affiliate_service()

    success, message = affiliate_service.process_payout(affiliate_id)

    if success:
        return RedirectResponse(f"/admin/payouts?msg={message}", status_code=302)
    else:
        return RedirectResponse(f"/admin/payouts?msg=Error: {message}", status_code=302)
```

2. **Add render_payout_admin() to admin.py services:**

```python
def render_payout_admin(payouts: list, message: str = "") -> str:
    """Render payout management page."""
    # Table showing pending payouts:
    # - Affiliate code, name, email
    # - Amount
    # - Payout method + details
    # - Request date
    # - "Mark Paid" button

    # Navigation links to /admin and /admin/affiliates
```

3. **Add milestone email function to email.py:**

```python
async def send_affiliate_milestone_email(
    to_email: str,
    affiliate_name: str,
    milestone_amount: str
) -> EmailResult:
    """
    Send milestone celebration email to affiliate.

    Args:
        to_email: Affiliate's email
        affiliate_name: Affiliate's name
        milestone_amount: Formatted amount (e.g., "$500")

    Returns:
        EmailResult with success/error
    """
    subject = f"Congratulations! You've earned {milestone_amount} with Thunderbird"

    body = f"""
Hi {affiliate_name},

Congratulations! You've just crossed {milestone_amount} in total earnings as a Thunderbird affiliate.

Thank you for spreading the word about weather forecasts for hikers. Your referrals are helping adventurers stay safe on the trail.

Keep up the great work!

Best,
The Thunderbird Team

---
View your dashboard: {settings.BASE_URL}/affiliate/dashboard
Request payout: {settings.BASE_URL}/affiliate/payout
"""

    return await send_email(to_email, subject, body)
```

4. **Integrate milestone check into webhook commission creation:**

In `backend/app/routers/webhook.py`, after commission is created:

```python
# After commission_result.success:
# Check for milestone
milestone = affiliate_service.check_milestones(affiliate_id)
if milestone:
    await affiliate_service.send_milestone_email(affiliate_id, milestone)
    logger.info(f"Milestone email sent: ${milestone/100:.0f} for affiliate {affiliate_id}")
```
  </action>
  <verify>
    grep -n "/admin/payouts" backend/app/routers/admin.py && grep -n "milestone" backend/app/services/email.py
  </verify>
  <done>Admin has /admin/payouts page to view and process payouts; milestone emails sent when affiliates hit $50/$100/$500/$1000 thresholds</done>
</task>

</tasks>

<verification>
1. Payout request: `curl -X POST /api/affiliates/payout/request/TESTCODE`
2. Admin payouts page: Visit /admin/payouts
3. Mark paid: Click "Mark Paid" button, verify commission status changes
4. Milestone email: Create test commission that crosses $50, check email sent
</verification>

<success_criteria>
- Affiliates can request payout when available >= $50
- Request fails with message if < $50 or no payout method set
- Admin sees list of pending payouts at /admin/payouts
- Admin can mark payouts as paid (changes status: requested -> paid)
- Milestone emails sent at $50, $100, $500, $1000 thresholds
- Commission status flow works: pending -> available (30 days) -> requested -> paid
</success_criteria>

<output>
After completion, create `.planning/phases/05-affiliates/05-05-SUMMARY.md`
</output>
