---
phase: 05-affiliates
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - backend/app/routers/admin.py
  - backend/app/services/admin.py
  - backend/app/routers/payments.py
autonomous: true

must_haves:
  truths:
    - "Admin can create new affiliates with custom terms"
    - "Admin can edit affiliate discount_percent, commission_percent, trailing_months"
    - "Admin can activate/deactivate affiliates"
    - "Creating affiliate auto-creates linked discount code"
    - "Affiliate codes apply discount at checkout"
  artifacts:
    - path: "backend/app/routers/admin.py"
      provides: "Admin routes for affiliate CRUD"
      contains: "/admin/affiliates"
    - path: "backend/app/services/admin.py"
      provides: "render_affiliate_admin() HTML template"
      contains: "def render_affiliate"
  key_links:
    - from: "backend/app/routers/admin.py"
      to: "backend/app/models/affiliates.py"
      via: "affiliate_store CRUD operations"
      pattern: "affiliate_store\\.(create|get|update)"
    - from: "backend/app/routers/admin.py"
      to: "backend/app/models/payments.py"
      via: "discount_code_store.create() with affiliate_id"
      pattern: "discount_code_store\\.create.*affiliate_id"
---

<objective>
Build admin console for affiliate management and integrate affiliate codes with checkout.

Purpose: Enable AFFL-01 (admin creates affiliates), AFFL-02 (configurable terms), and AFFL-03 (affiliate codes as discount codes). Admin needs full control over affiliate program.

Output: Admin UI at /admin/affiliates for CRUD operations, plus checkout integration that applies affiliate discounts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-affiliates/05-CONTEXT.md
@.planning/phases/05-affiliates/05-RESEARCH.md

# Prior plan context
@.planning/phases/05-affiliates/05-01-SUMMARY.md
@.planning/phases/05-affiliates/05-02-SUMMARY.md

# Admin pattern to follow
@backend/app/routers/admin.py
@backend/app/services/admin.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add affiliate admin HTML template</name>
  <files>backend/app/services/admin.py</files>
  <action>
Add affiliate management HTML templates to `backend/app/services/admin.py`.

1. **Add render_affiliate_admin() function** following the pattern of render_admin():
```python
def render_affiliate_admin(affiliates: list, message: str = "") -> str:
    """Render affiliate management page."""
    # Table showing all affiliates with:
    # - Code, Name, Email
    # - Discount %, Commission %, Trailing (months or "Forever")
    # - Status (Active/Inactive badge)
    # - Actions: Edit, Toggle Active, View Stats

    # Form for creating new affiliate:
    # - Code (text, required, uppercase)
    # - Name (text, required)
    # - Email (email, required)
    # - Discount % (number, 0-100, default 10)
    # - Commission % (number, 0-100, default 20)
    # - Trailing duration (select: 6, 12, 24 months, Forever)
    # - Payout method (select: PayPal, Bank Transfer)
    # - Payout details (text, e.g., PayPal email or bank info)

    # Navigation link back to /admin
```

2. **Add render_affiliate_edit() function** for edit form:
```python
def render_affiliate_edit(affiliate, message: str = "") -> str:
    """Render affiliate edit page."""
    # Pre-filled form with current values
    # Same fields as create form
    # Save and Cancel buttons
```

3. **Add render_affiliate_stats() function** for viewing affiliate performance:
```python
def render_affiliate_stats(affiliate, stats: dict, message: str = "") -> str:
    """Render affiliate stats page."""
    # Shows: Total clicks, Total conversions, Conversion rate
    # Total revenue generated, Total commission earned
    # Commission by status (pending, available, paid)
    # Recent conversions table
```

Use the existing admin CSS styling (inline styles matching render_admin()).
Include message display for success/error feedback.
  </action>
  <verify>
    python -c "from backend.app.services.admin import render_affiliate_admin; print('Template function exists')"
  </verify>
  <done>render_affiliate_admin(), render_affiliate_edit(), render_affiliate_stats() functions exist and return HTML</done>
</task>

<task type="auto">
  <name>Task 2: Add affiliate admin routes</name>
  <files>backend/app/routers/admin.py</files>
  <action>
Add affiliate management routes to `backend/app/routers/admin.py`.

1. **Import required modules at top:**
```python
from app.models.affiliates import affiliate_store, Affiliate
from app.models.payments import discount_code_store
from app.services.admin import render_affiliate_admin, render_affiliate_edit, render_affiliate_stats
```

2. **Add affiliate list page route:**
```python
@router.get("/affiliates", response_class=HTMLResponse)
async def admin_affiliates(request: Request):
    """Affiliate management page - requires admin login. AFFL-01."""
    if not require_admin(request):
        return RedirectResponse("/admin/login", status_code=302)

    affiliates = affiliate_store.list_all()
    message = request.query_params.get("msg", "")
    return render_affiliate_admin(affiliates, message)
```

3. **Add create affiliate route:**
```python
@router.post("/affiliates/create")
async def admin_create_affiliate(request: Request):
    """Create new affiliate. AFFL-01, AFFL-02."""
    if not require_admin(request):
        return RedirectResponse("/admin/login", status_code=302)

    form = await request.form()

    try:
        code = form.get("code", "").strip().upper()
        name = form.get("name", "").strip()
        email = form.get("email", "").strip()
        discount_percent = int(form.get("discount_percent", 10))
        commission_percent = int(form.get("commission_percent", 20))
        trailing_months_str = form.get("trailing_months", "")
        trailing_months = int(trailing_months_str) if trailing_months_str and trailing_months_str != "forever" else None
        payout_method = form.get("payout_method", "").strip() or None
        payout_details = form.get("payout_details", "").strip() or None

        # Validate code doesn't exist
        if affiliate_store.get_by_code(code):
            return RedirectResponse(f"/admin/affiliates?msg=Error: Code {code} already exists", status_code=302)

        # Create affiliate
        affiliate = affiliate_store.create(
            code=code,
            name=name,
            email=email,
            discount_percent=discount_percent,
            commission_percent=commission_percent,
            trailing_months=trailing_months,
            payout_method=payout_method,
            payout_details=payout_details
        )

        # Auto-create linked discount code (AFFL-03)
        if discount_percent > 0:
            discount_code_store.create(
                code=code,
                discount_type="percent",
                discount_value=discount_percent,
                affiliate_id=affiliate.id
            )

        return RedirectResponse(f"/admin/affiliates?msg=Created affiliate {code}", status_code=302)

    except Exception as e:
        return RedirectResponse(f"/admin/affiliates?msg=Error: {str(e)}", status_code=302)
```

4. **Add edit affiliate routes:**
```python
@router.get("/affiliates/{affiliate_id}/edit", response_class=HTMLResponse)
async def admin_edit_affiliate_page(affiliate_id: int, request: Request):
    """Edit affiliate page."""
    if not require_admin(request):
        return RedirectResponse("/admin/login", status_code=302)

    affiliate = affiliate_store.get_by_id(affiliate_id)
    if not affiliate:
        return RedirectResponse("/admin/affiliates?msg=Affiliate not found", status_code=302)

    message = request.query_params.get("msg", "")
    return render_affiliate_edit(affiliate, message)

@router.post("/affiliates/{affiliate_id}/edit")
async def admin_edit_affiliate(affiliate_id: int, request: Request):
    """Update affiliate. AFFL-02."""
    if not require_admin(request):
        return RedirectResponse("/admin/login", status_code=302)

    form = await request.form()
    # Parse and update fields
    # Also update linked discount code if discount_percent changed
    # ...
```

5. **Add toggle active route:**
```python
@router.post("/affiliates/{affiliate_id}/toggle")
async def admin_toggle_affiliate(affiliate_id: int, request: Request):
    """Toggle affiliate active status."""
    if not require_admin(request):
        return RedirectResponse("/admin/login", status_code=302)

    affiliate = affiliate_store.get_by_id(affiliate_id)
    if not affiliate:
        return RedirectResponse("/admin/affiliates?msg=Affiliate not found", status_code=302)

    new_status = not affiliate.active
    affiliate_store.update_active(affiliate_id, new_status)

    status_msg = "activated" if new_status else "deactivated"
    return RedirectResponse(f"/admin/affiliates?msg=Affiliate {affiliate.code} {status_msg}", status_code=302)
```

6. **Add stats view route:**
```python
@router.get("/affiliates/{affiliate_id}/stats", response_class=HTMLResponse)
async def admin_affiliate_stats(affiliate_id: int, request: Request):
    """View affiliate performance stats. AFFL-06 (partial)."""
    if not require_admin(request):
        return RedirectResponse("/admin/login", status_code=302)

    affiliate = affiliate_store.get_by_id(affiliate_id)
    if not affiliate:
        return RedirectResponse("/admin/affiliates?msg=Affiliate not found", status_code=302)

    # Get stats
    from app.models.affiliates import commission_store, click_store
    clicks = click_store.count_by_affiliate(affiliate_id)
    commissions = commission_store.get_by_affiliate_id(affiliate_id)

    stats = {
        "clicks": clicks,
        "conversions": len(set(c.account_id for c in commissions)),
        "total_commission_cents": sum(c.amount_cents for c in commissions),
        "pending_cents": sum(c.amount_cents for c in commissions if c.status == "pending"),
        "available_cents": sum(c.amount_cents for c in commissions if c.status == "available"),
        "paid_cents": sum(c.amount_cents for c in commissions if c.status == "paid"),
    }

    return render_affiliate_stats(affiliate, stats)
```
  </action>
  <verify>
    grep -n "/admin/affiliates" backend/app/routers/admin.py | head -5
  </verify>
  <done>Admin routes exist for /admin/affiliates (list), /affiliates/create (POST), /affiliates/{id}/edit, /affiliates/{id}/toggle, /affiliates/{id}/stats</done>
</task>

<task type="auto">
  <name>Task 3: Integrate affiliate code lookup at checkout</name>
  <files>backend/app/routers/payments.py</files>
  <action>
Update `backend/app/routers/payments.py` to look up affiliate from discount code and pass to payment service.

1. **Update CreateCheckoutRequest** to accept affiliate tracking params:
```python
class CreateCheckoutRequest(BaseModel):
    """Request to create Stripe checkout session."""
    discount_code: Optional[str] = None
    success_url: Optional[str] = None
    cancel_url: Optional[str] = None
    entry_path: Optional[str] = None
    route_id: Optional[int] = None
    sub_id: Optional[str] = None  # ADD: Campaign tracking
```

2. **Update create_checkout endpoint** to look up affiliate from discount code:
```python
@router.post("/checkout", response_model=CreateCheckoutResponse)
async def create_checkout(
    request: CreateCheckoutRequest,
    account: Account = Depends(get_current_account)
):
    # ... existing validation ...

    # Look up affiliate from discount code (AFFL-03)
    affiliate_id = None
    if request.discount_code:
        from app.models.payments import discount_code_store
        discount = discount_code_store.get_by_code(request.discount_code)
        if discount and discount.affiliate_id:
            affiliate_id = discount.affiliate_id

    payment_service = get_payment_service()
    result = await payment_service.create_checkout_session(
        account_id=account.id,
        discount_code=request.discount_code,
        success_url=request.success_url,
        cancel_url=request.cancel_url,
        entry_path=request.entry_path,
        route_id=request.route_id,
        affiliate_id=affiliate_id,  # ADD
        sub_id=request.sub_id  # ADD
    )
    # ...
```

3. **Update buy_now_checkout endpoint** similarly:
```python
@router.post("/buy-now", response_model=BuyNowCheckoutResponse)
async def buy_now_checkout(request: BuyNowCheckoutRequest):
    # ...

    # Look up affiliate from discount code
    affiliate_id = None
    if request.discount_code:
        from app.models.payments import discount_code_store
        discount = discount_code_store.get_by_code(request.discount_code)
        if discount and discount.affiliate_id:
            affiliate_id = discount.affiliate_id

    result = await payment_service.create_checkout_session_with_metadata(
        # ... existing params ...
        affiliate_id=affiliate_id,
        sub_id=getattr(request, 'sub_id', None)
    )
```

4. **Add validation to prevent discount code stacking** (from RESEARCH.md pitfalls):
   - If discount code is affiliate code, don't allow another discount code in same checkout
   - Document in API response if code is affiliate vs promo
  </action>
  <verify>
    grep -n "affiliate_id" backend/app/routers/payments.py | head -5
  </verify>
  <done>Checkout endpoints look up affiliate_id from discount codes and pass to payment service; affiliate codes apply discount at checkout</done>
</task>

</tasks>

<verification>
1. Admin pages load: Visit /admin/affiliates (requires admin login)
2. Create affiliate creates discount code: Check both tables after creation
3. Checkout with affiliate code: `curl -X POST /api/payments/checkout -d '{"discount_code": "HIKER20"}'` includes affiliate_id in Stripe metadata
</verification>

<success_criteria>
- /admin/affiliates page lists all affiliates
- Admin can create affiliate with custom discount %, commission %, trailing duration
- Creating affiliate auto-creates linked discount code
- Admin can edit, toggle active, view stats for each affiliate
- Checkout endpoint looks up affiliate from discount code
- affiliate_id flows through to Stripe metadata
</success_criteria>

<output>
After completion, create `.planning/phases/05-affiliates/05-03-SUMMARY.md`
</output>
