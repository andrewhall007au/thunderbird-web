---
phase: 12-companion-app
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/prototype/page.tsx
  - app/prototype/components/PrototypeMap.tsx
  - app/prototype/components/TrailPicker.tsx
  - app/prototype/components/PinPanel.tsx
autonomous: true

must_haves:
  truths:
    - "New /prototype route loads without auth"
    - "Map displays with topo basemap and trail line"
    - "User can select a trail from the picker and it loads on the map"
    - "Tapping the map drops a pin at that location"
    - "Pin shows latitude and longitude"
    - "Copy for SMS button copies WX command to clipboard"
    - "Multiple pins can be dropped (up to 8)"
    - "Multi-pin SMS export generates WX with all pin coordinates"
    - "Works on mobile viewport (responsive)"
  artifacts:
    - path: "app/prototype/page.tsx"
      provides: "Main prototype page with map + pin panel layout"
      min_lines: 40
    - path: "app/prototype/components/PrototypeMap.tsx"
      provides: "MapLibre GL map with trail display and pin drop"
      min_lines: 100
    - path: "app/prototype/components/TrailPicker.tsx"
      provides: "Trail search and selection dropdown"
      min_lines: 50
    - path: "app/prototype/components/PinPanel.tsx"
      provides: "Pin list with coordinates and SMS copy buttons"
      min_lines: 80
  key_links:
    - from: "app/prototype/components/PrototypeMap.tsx"
      to: "app/data/popularTrails.ts"
      via: "import trail data"
      pattern: "import.*popularTrails"
    - from: "app/prototype/components/TrailPicker.tsx"
      to: "app/data/popularTrails.ts"
      via: "import trail metadata"
      pattern: "import.*popularTrails"
---

<objective>
Build the foundation of the Phase 12A web POC: a /prototype page where users can select a trail, view it on a topo map, drop pins, and copy formatted WX coordinates for SMS.

Purpose: This is Step 1 of the companion app POC. The coordinate picker + SMS export is the immediate value — it works TODAY on any carrier with satellite SMS (Telstra, T-Mobile, Rogers, One NZ). No weather API integration yet (that's Plan 12-02). This plan validates the core interaction: trail → pin → SMS.

Output: A working /prototype page with map, trail picker, pin drop, and SMS coordinate copy.

Key architecture decisions:
- New Next.js route at /prototype — completely standalone, no auth required
- Reuse existing trail data from popularTrails.ts + /public/trail-data/ JSON files
- Reuse MapLibre GL JS + react-map-gl (already installed v5.16.0 / v8.1.0)
- Mobile-first responsive layout (this will be used on phones in the field)
- Pin state is local only (no backend storage — this is a UX prototype)
- Copy-to-clipboard for SMS uses navigator.clipboard API
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/12-companion-app/PROPOSAL.md
@.planning/phases/12-companion-app/RESEARCH.md

# Existing map components to reference (DO NOT modify these — build new equivalents):
@app/components/map/MapEditor.tsx
@app/components/map/WaypointMarker.tsx
@app/components/map/RouteTrack.tsx
@app/components/map/LocationSearch.tsx

# Trail data:
@app/data/popularTrails.ts (first 50 lines — understand the TrailData interface and loading pattern)
@app/lib/trailMatch.ts (GPS parsing and trailhead data)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /prototype page layout with mobile-first design</name>
  <files>app/prototype/page.tsx</files>
  <action>
Create a new Next.js page at `app/prototype/page.tsx`. This is the main entry point for the companion app POC.

Layout structure (mobile-first):
```
┌─────────────────────┐
│ Trail Picker (top)   │  ← Collapsed to trail name when selected
├─────────────────────┤
│                     │
│     MAP             │  ← Takes all available vertical space
│   (full width)      │
│                     │
├─────────────────────┤
│ Pin Panel (bottom)  │  ← Expandable sheet with pin list + copy buttons
└─────────────────────┘
```

Requirements:
1. `'use client'` directive — client component
2. Dynamic import for PrototypeMap (avoid SSR with MapLibre): `const PrototypeMap = dynamic(() => import('./components/PrototypeMap'), { ssr: false })`
3. NO auth requirement — this page is publicly accessible
4. State management with React hooks:
   - `selectedTrailId: string | null` — currently selected trail
   - `pins: Pin[]` — array of dropped pins (max 8)
   - `Pin` type: `{ id: string, lat: number, lng: number, label: string }`
5. Pin IDs: use sequential letters A, B, C, D... (up to H for 8 pins)
6. Full viewport height layout: `h-screen flex flex-col`
7. Map takes remaining space: `flex-1`
8. Pin panel at bottom: fixed height or expandable
9. Add a simple header bar with "Thunderbird Trail Weather" title and a small help text: "Drop pins along a trail. Copy coordinates for SMS forecast."
10. Wrap in Suspense for the dynamic import

Pin management functions (passed to child components):
- `addPin(lat, lng)` — adds pin with next letter label, max 8
- `removePin(id)` — removes a specific pin
- `clearPins()` — removes all pins

Tailwind styling: dark theme (zinc-900 bg, zinc-100 text) to match outdoor/hiking aesthetic. Keep it clean and minimal.
  </action>
  <verify>
Run `npm run build` — page should compile. Run `npm run dev` and navigate to `http://localhost:3000/prototype` — should see the layout skeleton.
  </verify>
  <done>
/prototype page created with mobile-first layout, state management for trail selection and pins, dynamic map import.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PrototypeMap component with trail display and pin drop</name>
  <files>app/prototype/components/PrototypeMap.tsx</files>
  <action>
Create the main map component. Reference `app/components/map/MapEditor.tsx` for patterns but build a fresh, simplified version.

Props:
```typescript
interface PrototypeMapProps {
  trailGeojson: GeoJSON.Feature | null;
  pins: Pin[];
  onMapClick: (lat: number, lng: number) => void;
  onPinRemove: (id: string) => void;
}
```

Implementation:

1. **Map setup:** Use `react-map-gl` Map component with `maplibre-gl` as mapLib. Same pattern as MapEditor.tsx:
   ```typescript
   import Map, { Source, Layer, Marker, NavigationControl } from 'react-map-gl/maplibre';
   import 'maplibre-gl/dist/maplibre-gl.css';
   ```

2. **Basemap:** Use OpenTopoMap raster tiles (already configured in existing code). Style object:
   ```typescript
   const topoStyle = {
     version: 8,
     sources: {
       'topo-tiles': {
         type: 'raster',
         tiles: ['https://tile.opentopomap.org/{z}/{x}/{y}.png'],
         tileSize: 256,
         attribution: '...'
       }
     },
     layers: [{ id: 'topo', type: 'raster', source: 'topo-tiles' }]
   };
   ```

3. **Trail line rendering:** When `trailGeojson` is provided, render as a Source+Layer:
   - Line color: `#FF10F0` (magenta, matches existing RouteTrack)
   - Line width: 3
   - White border line behind it (width 5, white) for contrast on topo
   - Auto-fit map bounds to trail using `mapRef.current?.fitBounds()`

4. **Pin drop on click:** `onClick` handler extracts coordinates:
   ```typescript
   const handleClick = (e: MapLayerMouseEvent) => {
     onMapClick(e.lngLat.lat, e.lngLat.lng);
   };
   ```

5. **Pin markers:** Render each pin as a `<Marker>`. Visual design:
   - Circular marker with the pin label letter (A, B, C...)
   - Size: 32x32px circle
   - Default color: `bg-blue-500` (will change to severity colors in Plan 12-03)
   - White text, bold, centered
   - Small tail/stem pointing down
   - Hover: show lat/lon tooltip
   - Click on existing pin: select it (highlight)
   - Long-press or double-click: remove pin (call onPinRemove)

6. **Viewport state:** Internal `viewState` with `onMove` handler. Initial view: US center (39.8, -98.5, zoom 4) if no trail loaded. Fly to trail bounds when trail changes.

7. **NavigationControl:** Top-right corner for zoom +/- buttons.

8. **Cooperative gestures:** Enable (`cooperativeGestures: true`) so scroll doesn't hijack the page on mobile. But also allow single-finger pan on mobile (this is the primary device).

Actually, for mobile-first: disable cooperative gestures. The map IS the main content. Users should be able to pan freely. Add `touchPitch: false` to prevent accidental 3D tilt.

9. **Attribution:** OpenTopoMap attribution in bottom-left (MapLibre handles this automatically via the style).
  </action>
  <verify>
Run `npm run build` to check TypeScript compilation. Verify map renders on `/prototype` with topo tiles.
  </verify>
  <done>
PrototypeMap renders topo map, displays trail line, supports pin drop via click, shows lettered pin markers.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create TrailPicker with search and country-grouped selection</name>
  <files>app/prototype/components/TrailPicker.tsx</files>
  <action>
Create a trail picker component that lets users search and select from the 252 available trails. Loads trail coordinate data on selection.

Props:
```typescript
interface TrailPickerProps {
  selectedTrailId: string | null;
  onTrailSelect: (trailId: string, geojson: GeoJSON.Feature) => void;
}
```

Implementation:

1. **Import trail data:** Import `popularTrails`, `lazyTrailIds`, `loadTrailCoordinates` from `app/data/popularTrails`. These provide the metadata and lazy-loading infrastructure.

2. **Search state:** Text input with search filtering. Filter by trail name, region, or country name. Show match count.

3. **Display modes:**
   - **Collapsed (trail selected):** Show selected trail name as a compact bar. Tap to expand and change trail.
   - **Expanded (no trail / changing):** Full dropdown with search and scrollable list.

4. **Country grouping:** Group trails by country code. Display country name as section header. Sort countries alphabetically, trails alphabetically within each country.
   ```typescript
   const COUNTRY_NAMES: Record<string, string> = {
     AU: 'Australia', CA: 'Canada', FR: 'France', DE: 'Germany',
     IT: 'Italy', JP: 'Japan', NZ: 'New Zealand', ZA: 'South Africa',
     CH: 'Switzerland', GB: 'United Kingdom', US: 'United States'
   };
   ```

5. **Trail selection flow:**
   a. User taps a trail in the list
   b. Check if trail ID is in `lazyTrailIds`:
      - If yes: call `loadTrailCoordinates(trailId)` to fetch from `/public/trail-data/{id}.json`
      - If no: use inline coordinates from `popularTrails`
   c. Convert coordinates to GeoJSON LineString Feature
   d. Call `onTrailSelect(trailId, geojsonFeature)`
   e. Collapse the picker

6. **GeoJSON conversion helper:**
   ```typescript
   function trailToGeojson(trail: TrailData): GeoJSON.Feature {
     return {
       type: 'Feature',
       properties: { name: trail.name },
       geometry: {
         type: 'LineString',
         coordinates: trail.coordinates // already [lng, lat, ele]
       }
     };
   }
   ```

7. **Loading state:** Show spinner while fetching lazy trail data.

8. **Styling:** Dark theme dropdown. Country headers in zinc-500 text. Trail items show name + distance. Selected trail highlighted.

9. **Quick picks:** Add a row of popular trail chips at the top (before search): "Overland Track", "PCT", "Wonderland Trail", "Milford Track", "Tour du Mont Blanc". Tapping a chip selects that trail immediately.
  </action>
  <verify>
Run build. Verify trail picker shows all 252 trails grouped by country. Select a trail — verify coordinates load and map zooms to trail.
  </verify>
  <done>
TrailPicker component with search, country grouping, lazy loading, and quick picks. Selecting a trail loads coordinates and returns GeoJSON.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create PinPanel with coordinate display and SMS copy</name>
  <files>app/prototype/components/PinPanel.tsx</files>
  <action>
Create the bottom panel that shows all dropped pins and provides SMS coordinate export.

Props:
```typescript
interface PinPanelProps {
  pins: Pin[];
  onRemovePin: (id: string) => void;
  onClearPins: () => void;
}
```

Implementation:

1. **Pin list:** Display each pin as a row:
   ```
   [A] -42.753°, 146.012°   [×]
   [B] -42.748°, 146.019°   [×]
   ```
   - Letter label in a colored circle (matches map marker)
   - Coordinates formatted to 3 decimal places
   - Remove button (× icon) on the right

2. **SMS Export section (below pin list):**

   a. **Single-pin copy** (when 1 pin): Button labeled "Copy WX Command"
      - Copies: `WX -42.753 146.012`
      - Format: `WX {lat} {lng}` with 3 decimal places, space-separated

   b. **Multi-pin copy** (when 2+ pins): Button labeled "Copy All Pins for SMS"
      - Copies: `WX -42.753 146.012 -42.748 146.019 -42.741 146.025`
      - All coordinates in one WX command
      - Show character count below the button (important: SMS is 160 chars)
      - If > 160 chars: show warning "Too long for single SMS — reduce pins"
      - Max ~4 pins fit in a single 160-char SMS

   c. **Individual pin copy**: Each pin row also has a small copy icon to copy just that pin's WX command

3. **Copy feedback:** When user taps copy, show brief "Copied!" toast/indicator (2 seconds). Use `navigator.clipboard.writeText()`. Fall back to `document.execCommand('copy')` for older browsers.

4. **Clear all button:** "Clear All Pins" at bottom, with confirmation (tap twice or confirm dialog).

5. **Empty state:** When no pins: "Tap the map to drop a pin" with a subtle map-pin icon.

6. **Expandable panel:** On mobile, the panel should be a bottom sheet that:
   - Shows pin count and "Copy" button in collapsed state
   - Expands to show full pin list on tap
   - Doesn't overlap the map too much when collapsed (max 80px)
   - Use a drag handle at the top for expansion

7. **Styling:** Dark theme (zinc-800 background). Pin letters match map marker colors. Compact layout for mobile.

8. **Pin count indicator:** Show "X/8 pins" in the panel header.
  </action>
  <verify>
Run build. Drop pins on the map — verify they appear in the panel. Test copy button — verify WX command format is correct. Test multi-pin copy and character count.
  </verify>
  <done>
PinPanel displays all pins with coordinates, provides single and multi-pin WX command copy, shows SMS character count, expandable bottom sheet on mobile.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no errors
2. `/prototype` loads without auth requirement
3. Trail picker shows all 252 trails grouped by country
4. Selecting a trail loads it on the topo map
5. Clicking the map drops a lettered pin (A, B, C...)
6. Up to 8 pins can be placed
7. PinPanel shows all pin coordinates
8. "Copy WX Command" copies correct format: `WX lat lng`
9. Multi-pin copy generates: `WX lat1 lng1 lat2 lng2...`
10. SMS character count displayed for multi-pin export
11. Works on mobile viewport (responsive layout)
12. Pins can be removed individually or all cleared
</verification>

<success_criteria>
- /prototype page loads and renders topo map
- Trail selection + map display works for any of the 252 trails
- Pin drop on map click places lettered markers
- WX SMS command copied to clipboard in correct format
- Multi-pin SMS export with character count
- Mobile-responsive layout
- No auth required
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/12-companion-app/12-01-SUMMARY.md`
</output>
