---
phase: 01-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/alembic.ini
  - backend/alembic/env.py
  - backend/alembic/script.py.mako
  - backend/alembic/versions/001_initial_schema.py
  - backend/app/models/database.py
  - backend/config/settings.py
autonomous: true

must_haves:
  truths:
    - "Alembic migrations create database from scratch"
    - "Existing database tables preserved"
    - "Future schema changes use Alembic"
  artifacts:
    - path: "backend/alembic.ini"
      provides: "Alembic configuration"
      contains: "script_location = alembic"
    - path: "backend/alembic/env.py"
      provides: "Migration environment with batch mode"
      contains: "render_as_batch=True"
    - path: "backend/alembic/versions/001_initial_schema.py"
      provides: "Initial migration for existing tables"
      contains: "def upgrade"
  key_links:
    - from: "backend/alembic/env.py"
      to: "backend/config/settings.py"
      via: "THUNDERBIRD_DB_PATH environment variable"
      pattern: "THUNDERBIRD_DB_PATH"
---

<objective>
Set up Alembic database migrations with SQLite batch mode

Purpose: FOUN-02 requires database migrations system. Alembic enables safe schema evolution, required for adding accounts table (Plan 03) and all future phases. SQLite requires batch mode for ALTER TABLE operations.

Output: Working Alembic setup with initial migration that can recreate existing schema
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/andrewhall/thunderbird-web/.planning/PROJECT.md
@/Users/andrewhall/thunderbird-web/.planning/ROADMAP.md
@/Users/andrewhall/thunderbird-web/.planning/phases/01-foundation/01-RESEARCH.md
@/Users/andrewhall/thunderbird-web/.planning/codebase/STACK.md

# Database model
@/Users/andrewhall/thunderbird-web/backend/app/models/database.py
@/Users/andrewhall/thunderbird-web/backend/config/settings.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Alembic with SQLite configuration</name>
  <files>
    backend/alembic.ini
    backend/alembic/env.py
    backend/alembic/script.py.mako
  </files>
  <action>
Initialize Alembic in the backend directory and configure for SQLite.

1. Initialize Alembic:
```bash
cd /Users/andrewhall/thunderbird-web/backend
alembic init alembic
```

2. Edit `backend/alembic.ini`:
   - Set `script_location = alembic`
   - Comment out default sqlalchemy.url (we'll set it in env.py)

3. Edit `backend/alembic/env.py` to configure SQLite with batch mode:

```python
from logging.config import fileConfig
from sqlalchemy import engine_from_config
from sqlalchemy import pool
from alembic import context
import os
import sys

# Add backend to path for imports
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

config = context.config

if config.config_file_name is not None:
    fileConfig(config.config_file_name)


def get_url():
    """Get database URL from environment."""
    db_path = os.getenv("THUNDERBIRD_DB_PATH", "thunderbird.db")
    # Handle both file path and URL formats
    if db_path.startswith("sqlite"):
        return db_path
    return f"sqlite:///{db_path}"


def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode."""
    url = get_url()
    context.configure(
        url=url,
        target_metadata=None,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
        render_as_batch=True,  # CRITICAL for SQLite
    )

    with context.begin_transaction():
        context.run_migrations()


def run_migrations_online() -> None:
    """Run migrations in 'online' mode."""
    configuration = config.get_section(config.config_ini_section) or {}
    configuration["sqlalchemy.url"] = get_url()

    connectable = engine_from_config(
        configuration,
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=None,
            render_as_batch=True,  # CRITICAL for SQLite
        )

        with context.begin_transaction():
            context.run_migrations()


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()
```

The `render_as_batch=True` is CRITICAL - SQLite doesn't support most ALTER TABLE operations, so Alembic needs to use batch mode which creates a new table, copies data, and renames.
  </action>
  <verify>
Verify Alembic is configured:
```bash
cd /Users/andrewhall/thunderbird-web/backend
alembic --version
alembic current
# Should show "(head)" or empty if no migrations yet
```
  </verify>
  <done>
- alembic.ini created and configured
- alembic/env.py configured with batch mode for SQLite
- Alembic CLI works
  </done>
</task>

<task type="auto">
  <name>Task 2: Create initial migration for existing schema</name>
  <files>
    backend/alembic/versions/001_initial_schema.py
  </files>
  <action>
Create an initial migration that represents the current database schema. This allows new installations to create the database from scratch via migrations.

First, examine the existing schema in `backend/app/models/database.py` to understand current tables:
- users (id, phone, name, route_id, current_camp_id, trip_status, etc.)
- safecheck_contacts (id, user_phone, name, phone, notify_interval)
- message_log (id, phone, direction, message_type, content, segments, etc.)

Create migration file manually (not autogenerate - we don't have SQLAlchemy models):

```bash
cd /Users/andrewhall/thunderbird-web/backend
alembic revision -m "initial_schema"
```

Edit the generated file to add the existing schema:

```python
"""initial_schema

Revision ID: 001
Revises:
Create Date: 2026-01-19

Creates the initial database schema matching existing tables.
"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '001'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Create initial tables."""

    # Users table - registered hikers
    op.create_table(
        'users',
        sa.Column('id', sa.Integer(), primary_key=True),
        sa.Column('phone', sa.String(20), unique=True, nullable=False),
        sa.Column('name', sa.String(100), nullable=True),
        sa.Column('route_id', sa.String(50), nullable=True),
        sa.Column('current_camp_id', sa.String(10), nullable=True),
        sa.Column('trip_status', sa.String(20), default='planning'),
        sa.Column('start_date', sa.String(10), nullable=True),
        sa.Column('end_date', sa.String(10), nullable=True),
        sa.Column('expected_return_time', sa.String(10), nullable=True),
        sa.Column('is_overdue', sa.Boolean(), default=False),
        sa.Column('created_at', sa.String(30), nullable=True),
        sa.Column('updated_at', sa.String(30), nullable=True),
        sa.Column('last_checkin_at', sa.String(30), nullable=True),
        sa.Column('alerts_enabled', sa.Boolean(), default=False),
    )

    # SafeCheck contacts table
    op.create_table(
        'safecheck_contacts',
        sa.Column('id', sa.Integer(), primary_key=True),
        sa.Column('user_phone', sa.String(20), nullable=False),
        sa.Column('name', sa.String(100), nullable=True),
        sa.Column('phone', sa.String(20), nullable=False),
        sa.Column('notify_interval', sa.Integer(), default=24),
    )

    # Message log table
    op.create_table(
        'message_log',
        sa.Column('id', sa.Integer(), primary_key=True),
        sa.Column('phone', sa.String(20), nullable=False),
        sa.Column('direction', sa.String(10), nullable=False),
        sa.Column('message_type', sa.String(30), nullable=True),
        sa.Column('content', sa.Text(), nullable=True),
        sa.Column('segments', sa.Integer(), default=1),
        sa.Column('cost_aud', sa.Float(), nullable=True),
        sa.Column('twilio_sid', sa.String(50), nullable=True),
        sa.Column('status', sa.String(20), nullable=True),
        sa.Column('error_code', sa.String(10), nullable=True),
        sa.Column('error_message', sa.Text(), nullable=True),
        sa.Column('created_at', sa.String(30), nullable=True),
    )


def downgrade() -> None:
    """Drop all tables."""
    op.drop_table('message_log')
    op.drop_table('safecheck_contacts')
    op.drop_table('users')
```

Note: The column types and names must match what's in database.py. Check the actual implementation and adjust if needed.
  </action>
  <verify>
Test migration on a fresh database:
```bash
cd /Users/andrewhall/thunderbird-web/backend

# Backup existing database
cp thunderbird.db thunderbird.db.backup 2>/dev/null || true

# Create fresh test database
rm -f thunderbird_test.db
THUNDERBIRD_DB_PATH=thunderbird_test.db alembic upgrade head

# Verify tables created
sqlite3 thunderbird_test.db ".tables"
# Should show: message_log  safecheck_contacts  users

# Clean up test database
rm thunderbird_test.db
```
  </verify>
  <done>
- Initial migration created matching existing schema
- Migration runs successfully on fresh database
- All three tables (users, safecheck_contacts, message_log) created
  </done>
</task>

<task type="auto">
  <name>Task 3: Update database.py to use Alembic for schema</name>
  <files>
    backend/app/models/database.py
    backend/config/settings.py
  </files>
  <action>
Update the database module to work with Alembic instead of inline schema creation.

1. Update `backend/config/settings.py` to add a note about migrations:
   - Add comment: `# Database schema managed by Alembic - see alembic/versions/`
   - No code changes needed

2. Update `backend/app/models/database.py`:
   - Remove or comment out `_init_db()` table creation code
   - Add guard that checks if tables exist before creating
   - Add helper function to run migrations programmatically if needed

   Find the `_init_db` method in SQLiteUserStore (or similar) and modify:

```python
def _init_db(self):
    """
    Initialize database connection.

    Note: Schema is managed by Alembic migrations.
    Run `alembic upgrade head` to create/update schema.
    """
    # Check if tables exist (for backwards compatibility)
    with self._get_connection() as conn:
        cursor = conn.execute(
            "SELECT name FROM sqlite_master WHERE type='table' AND name='users'"
        )
        if not cursor.fetchone():
            import logging
            logger = logging.getLogger(__name__)
            logger.warning(
                "Database tables not found. Run 'alembic upgrade head' to initialize."
            )
```

The key change is that we DON'T create tables inline anymore - we warn if they're missing and expect Alembic to handle schema.

IMPORTANT: Keep the existing code functional. The migration is additive - existing databases continue to work, new databases should use `alembic upgrade head`.
  </action>
  <verify>
1. Verify existing database still works:
```bash
cd /Users/andrewhall/thunderbird-web/backend
python -c "from app.models.database import SQLiteUserStore; store = SQLiteUserStore(); print('DB connection OK')"
```

2. Run tests to ensure no regressions:
```bash
pytest tests/ -v
```

3. Verify Alembic can detect current state:
```bash
alembic current
# May show empty (existing DB predates migrations) or the revision
```
  </verify>
  <done>
- database.py updated to work with Alembic
- Inline table creation removed/guarded
- Existing database continues to function
- Tests pass
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Alembic structure:
```bash
ls -la /Users/andrewhall/thunderbird-web/backend/alembic/
# Should show: env.py, script.py.mako, versions/

ls -la /Users/andrewhall/thunderbird-web/backend/alembic/versions/
# Should show at least one migration file
```

2. Fresh database test:
```bash
cd /Users/andrewhall/thunderbird-web/backend
rm -f test_alembic.db
THUNDERBIRD_DB_PATH=test_alembic.db alembic upgrade head
sqlite3 test_alembic.db ".schema users"
# Should show users table schema
rm test_alembic.db
```

3. Existing database compatibility:
```bash
cd /Users/andrewhall/thunderbird-web/backend
pytest tests/ -v
# All tests pass
```
</verification>

<success_criteria>
- [ ] Alembic initialized with alembic.ini and env.py
- [ ] env.py configured with render_as_batch=True for SQLite
- [ ] Initial migration created for existing schema (users, safecheck_contacts, message_log)
- [ ] Fresh database can be created with `alembic upgrade head`
- [ ] Existing database continues to work
- [ ] database.py no longer creates tables inline
- [ ] All tests pass
- [ ] FOUN-02 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
