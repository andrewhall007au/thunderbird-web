// Trailhead locations for nearby trail matching
// [trailId, lat, lng]
export const trailheads: [string, number, number][] = [
  ['abel_tasman_coast_track', -40.81, 172.956],
  ['adlerweg_eagle_walk', 47.7, 12.334],
  ['affric_kintail_way', 57.343, -4.75],
  ['alamere_falls_via_coast_trail', 37.991, -122.81],
  ['algonquin_highlands_backpacking_trail', 45.631, -78.872],
  ['alta_via_1_dolomites', 46.654, 12.06],
  ['alta_via_2_dolomites', 46.697, 11.683],
  ['alum_cave_trail_to_mt_leconte', 35.63, -83.452],
  ['angels_landing', 37.26, -112.952],
  ['annapurna_base_camp_trek', 28.531, 83.878],
  ['annapurna_circuit', 28.313, 84.402],
  ['aonach_eagach_ridge', 56.681, -5.003],
  ['appalachian_trail', 45.904, -68.922],
  ['arizona_trail', 37.001, -112.035],
  ['australian_alps_walking_track', -37.941, 146.452],
  ['bald_head_walk', -35.099, 117.968],
  ['beartooth_traverse', 44.943, -109.539],
  ['ben_lomond', 56.16, -4.642],
  ['ben_lomond_track', -45.007, 168.616],
  ['ben_nevis_via_mountain_track', 56.804, -5.062],
  ['berg_lake_trail', 53.156, -119.154],
  ['besseggen_ridge', 61.496, 8.814],
  ['bibbulmun_track', -31.973, 116.061],
  ['blue_gum_forest_walk', -33.611, 150.359],
  ['bluff_knoll', -34.368, 118.243],
  ['bright_angel_trail_to_plateau_point', 36.057, -112.144],
  ['bruce_trail_bruce_peninsula', 45.249, -81.613],
  ['buachaille_etive_mor', 56.665, -4.905],
  ['buckskin_gulch', 37.019, -112.025],
  ['cactus_to_clouds_trail', 33.816, -116.556],
  ['caminito_del_rey', 36.917, -4.774],
  ['camino_de_santiago_frances', 42.872, -7.898],
  ['canberra_centenary_trail', -35.272, 149.106],
  ['canol_heritage_trail', 62.345, -131.597],
  ['cape_brett_track', -35.173, 174.33],
  ['castle_rock_granite_skywalk', -34.676, 117.871],
  ['cape_to_cape_track', -33.539, 115.02],
  ['cape_wrath_trail', 56.858, -5.407],
  ['carnarvon_great_walk', -25.061, 148.237],
  ['cascade_canyon_to_lake_solitude', 43.765, -110.813],
  ['cateran_trail', 56.651, -3.344],
  ['cathedral_rock_trail', 34.825, -111.789],
  ['chain_lakes_loop', 48.855, -121.686],
  ['chilkoot_trail', 59.845, -134.996],
  ['cleveland_way', 54.437, -0.534],
  ['clouds_rest_trail', 37.801, -119.459],
  ['coast_to_coast_walk', 54.391, -1.302],
  ['colorado_trail', 39.491, -105.094],
  ['continental_divide_trail', 33.679, -107.848],
  ['cooloola_great_walk', -26.351, 153.044],
  ['cotswold_way', 52.051, -1.781],
  ['crypt_lake_trail', 49.0, -113.843],
  ['cucamonga_peak_trail', 34.225, -117.583],
  ['cumbria_way', 54.443, -3.065],
  ['dales_way', 53.929, -1.835],
  ['delicate_arch_trail', 38.736, -109.521],
  ['devil_s_postpile_to_rainbow_falls', 37.595, -119.089],
  ['dipsea_trail', 37.898, -122.637],
  ['drakensberg_grand_traverse', -28.747, 28.88],
  ['e5_alps_crossing', 47.5, 10.274],
  ['eagle_creek_trail', 45.579, -121.843],
  ['east_coast_trail', 47.023, -52.884],
  ['eastern_arthur_range_traverse', -43.038, 146.299],
  ['eagles_view_trail', -31.883, 116.092],
  ['emory_peak_trail', 29.27, -103.302],
  ['enchanted_valley_via_graves_creek', 47.573, -123.569],
  ['enchantments_thru_hike', 47.528, -120.821],
  ['everest_base_camp_trek', 27.825, 86.729],
  ['everest_three_passes_trek', 27.825, 86.729],
  ['falls_to_hotham_alpine_crossing', -36.971, 147.161],
  ['federation_peak', -43.232, 146.668],
  ['fimmvorduhals_trail', 63.678, -19.483],
  ['four_mile_trail_to_glacier_point', 37.734, -119.602],
  ['four_pass_loop', 39.089, -106.977],
  ['franconia_ridge_loop', 44.108, -71.628],
  ['frenchmans_cap', -42.209, 145.981],
  ['fraser_island_great_walk', -25.305, 153.054],
  ['freycinet_peninsula_circuit', -42.124, 148.292],
  ['fundy_footpath', 45.514, -65.158],
  ['garibaldi_lake_trail', 49.95, -123.102],
  ['gokyo_lakes_trek', 27.955, 86.692],
  ['gold_coast_hinterland_great_walk', -28.23, 153.135],
  ['golden_ears_trail', 49.36, -122.46],
  ['goldfields_track', -37.556, 143.865],
  ['gr10_french_pyrenees', 42.482, 3.129],
  ['gr11_pyrenean_traverse', 42.336, 3.203],
  ['gr20_corsica', 41.796, 9.225],
  ['grampians_peaks_trail', -36.891, 142.376],
  ['grand_canyon_track', -33.679, 150.328],
  ['granite_peak_montana', 45.246, -109.73],
  ['great_divide_trail', 48.999, -113.906],
  ['great_glen_way', 57.467, -4.274],
  ['great_north_walk', -32.926, 151.781],
  ['great_ocean_walk', -38.779, 143.664],
  ['hadrian_s_wall_path', 54.988, -1.53],
  ['hanging_lake_trail', 39.601, -107.191],
  ['heaphy_track', -41.072, 172.104],
  ['heysen_trail', -35.606, 138.095],
  ['high_sierra_trail_to_mount_whitney', 36.553, -118.748],
  ['highline_trail_glacier_np', 48.697, -113.718],
  ['hoh_river_to_blue_glacier', 47.862, -123.933],
  ['hollyford_track', -44.693, 168.126],
  ['hooker_valley_track', -43.717, 170.087],
  ['horsetail_falls_trail', 45.59, -122.066],
  ['howe_sound_crest_trail', 49.545, -123.241],
  ['humphreys_peak_trail', 35.329, -111.711],
  ['ice_age_trail', 43.19, -89.621],
  ['ice_lakes_basin', 37.807, -107.774],
  ['isle_royale', 47.918, -89.149],
  ['jatbula_trail', -14.179, 132.193],
  ['joffre_lakes_trail', 50.367, -122.5],
  ['john_muir_trail', 37.725, -119.545],
  ['juan_de_fuca_marine_trail', 48.533, -124.444],
  ['kalalau_trail', 22.22, -159.583],
  ['kanangra_to_katoomba', -33.988, 150.109],
  ['kangaroo_island_wilderness_trail', -35.95, 136.72],
  ['kepler_track', -45.441, 167.687],
  ['key_summit_track', -44.812, 168.13],
  ['kumano_kodo_nakahechi', 33.862, 135.723],
  ['kungsleden', 68.356, 18.769],
  ['la_cloche_silhouette_trail', 46.016, -81.401],
  ['lake_rhona', -42.608, 146.397],
  ['lake_waikaremoana_great_walk', -38.81, 176.991],
  ['lakes_trail_to_pear_lake', 36.598, -118.735],
  ['larapinta_trail', -23.581, 132.58],
  ['lassen_peak_trail', 40.475, -121.506],
  ['laugavegur_trail', 63.754, -19.361],
  ['lechweg', 47.172, 10.001],
  ['leeaberra_track', -41.862, 148.186],
  ['liathach_traverse', 57.553, -5.451],
  ['light_to_light_walk', -37.259, 150.047],
  ['long_range_traverse', 49.788, -57.839],
  ['long_trail', 45.009, -72.488],
  ['longs_peak_via_keyhole_route', 40.272, -105.557],
  ['lost_coast_trail', 40.045, -124.079],
  ['lycian_way', 36.19, 29.656],
  ['mailbox_peak_trail', 47.462, -121.639],
  ['mantario_trail', 49.841, -95.188],
  ['maple_pass_loop', 48.515, -120.736],
  ['mardi_himal_trek', 28.322, 83.83],
  ['maroon_bells_crater_lake', 39.088, -106.966],
  ['matemateaonga_track', -39.276, 174.748],
  ['meraner_hohenweg', 46.684, 11.045],
  ['milford_track', -44.932, 167.93],
  ['mist_trail_to_vernal_fall', 37.726, -119.552],
  ['mont_tremblant_summit_trail', 46.214, -74.581],
  ['moro_rock_trail', 36.544, -118.765],
  ['mount_adams_south_climb', 46.288, -121.553],
  ['mount_anne_circuit', -42.958, 146.362],
  ['mount_lofty_summit_via_waterfall_gully', -34.974, 138.709],
  ['mount_baldy_via_devil_s_backbone', 34.238, -117.658],
  ['mount_dana_trail', 37.911, -119.258],
  ['mount_hakusan', 36.155, 136.771],
  ['mount_hood_via_south_side_route', 45.332, -121.708],
  ['mount_katahdin_via_hunt_trail', 45.886, -69.0],
  ['mount_rishiri', 45.223, 141.213],
  ['mount_san_jacinto_via_marion_mountain', 33.753, -116.723],
  ['mount_shasta_via_avalanche_gulch', 41.372, -122.23],
  ['mount_si_trail', 47.488, -121.723],
  ['mount_tallac_trail', 38.922, -120.068],
  ['mount_washburn_trail', 44.798, -110.432],
  ['mount_whitney_trail', 36.559, -118.292],
  ['mt_bogong', -36.733, 147.235],
  ['mt_feathertop', -36.890, 147.076],
  ['mt_holdsworth_jumbo_circuit', -40.89, 175.45],
  ['mt_magog', -34.375, 118.079],
  ['mt_talyuberlup', -34.392, 118.063],
  ['mt_trio', -34.333, 118.121],
  ['mt_toolbrunup', -34.392, 118.063],
  ['mueller_hut_route', -43.714, 170.074],
  ['nakasendo_trail_magome_to_tsumago', 35.59, 137.601],
  ['nancy_peak_and_devils_slide', -34.684, 117.849],
  ['navajo_loop_and_queens_garden', 37.618, -112.162],
  ['north_dome_via_indian_rock', 37.756, -119.56],
  ['north_downs_way', 51.249, -0.323],
  ['observation_point_via_east_mesa', 37.278, -112.94],
  ['offa_s_dyke_path', 51.663, -2.663],
  ['old_ghost_road', -41.555, 172.033],
  ['old_rag_mountain_loop', 38.57, -78.3],
  ['overland_track', -41.636, 145.949],
  ['ozark_highlands_trail', 36.065, -92.577],
  ['pacific_crest_trail', 49.063, -120.788],
  ['pacific_northwest_trail', 48.762, -114.592],
  ['paparoa_track', -42.119, 171.367],
  ['pembrokeshire_coast_path', 52.005, -5.07],
  ['pen_y_fan_horseshoe', 51.882, -3.444],
  ['pennine_way', 55.144, -2.254],
  ['pinhoti_trail', 33.047, -86.234],
  ['pinnacles_walk', -37.049, 175.692],
  ['plain_of_six_glaciers_trail', 51.416, -116.226],
  ['poon_hill_trek', 28.316, 83.719],
  ['port_davey_track', -43.039, 146.299],
  ['precipice_trail_acadia', 44.351, -68.194],
  ['preikestolen_pulpit_rock', 58.987, 6.189],
  ['presidential_traverse', 44.371, -71.289],
  ['quandary_peak_east_ridge', 39.385, -106.062],
  ['queen_charlotte_track', -41.095, 174.234],
  ['rae_lakes_loop', 36.76, -118.412],
  ['rakiura_track', -46.893, 168.126],
  ['razorback_ridge', -36.976, 147.122],
  ['reesdart_track', -44.536, 168.558],
  ['rim_to_rim_grand_canyon', 36.207, -112.047],
  ['rob_roy_way', 56.173, -4.389],
  ['rota_vicentina_fishermans_trail', 37.597, -8.817],
  ['routeburn_track', -44.825, 168.118],
  ['royal_coast_track', -34.193, 151.037],
  ['ruta_del_cares', 43.231, -4.894],
  ['ryan_mountain_trail', 33.986, -116.135],
  ['samaria_gorge', 35.308, 23.918],
  ['scafell_pike_via_corridor_route', 54.454, -3.233],
  ['scenic_rim_trail', -27.834, 152.326],
  ['selvaggio_blu', 40.047, 9.696],
  ['sentier_des_caps_de_charlevoix', 47.123, -70.739],
  ['sentier_international_des_appalaches', 49.074, -64.543],
  ['sentiero_degli_dei', 40.629, 14.54],
  ['sentinel_pass_trail', 51.326, -116.19],
  ['six_foot_track', -33.704, 150.289],
  ['skyline_trail_jasper', 52.914, -118.001],
  ['skyline_trail_mount_rainier', 46.787, -121.737],
  ['snowdon_horseshoe', 53.076, -4.122],
  ['south_coast_track', -43.422, 146.162],
  ['south_downs_way', 50.752, 0.267],
  ['south_kaibab_to_phantom_ranch', 36.101, -112.09],
  ['south_sister_via_green_lakes', 44.055, -121.771],
  ['south_west_coast_path', 51.217, -3.623],
  ['southern_upland_way', 55.602, -2.723],
  ['speyside_way', 57.078, -4.061],
  ['st_cuthbert_s_way', 55.596, -2.72],
  ['stac_pollaidh', 58.045, -5.212],
  ['stein_valley_traverse', 50.273, -121.635],
  ['stirling_ridge_walk', -34.368, 118.243],
  ['stubaier_hohenweg', 47.138, 11.297],
  ['sunshine_coast_hinterland_great_walk', -26.698, 152.869],
  ['sunshine_coast_trail', 49.882, -124.546],
  ['superior_hiking_trail', 47.479, -91.123],
  ['tablelands_trail', 49.476, -57.966],
  ['tahoe_rim_trail', 39.153, -120.171],
  ['tama_lakes_track', -39.198, 175.566],
  ['tasman_cape_pillar', -43.224, 148.001],
  ['telescope_peak_trail', 36.226, -116.881],
  ['teton_crest_trail', 43.548, -110.932],
  ['the_narrows', 37.286, -112.948],
  ['the_ridgeway', 51.76, -0.74],
  ['thorsborne_trail', -18.449, 146.327],
  ['three_capes_track', -43.156, 147.896],
  ['three_sisters_loop', 44.049, -121.791],
  ['timberline_trail', 45.38, -121.784],
  ['tombstone_grizzly_lake_trail', 64.413, -138.302],
  ['tongariro_alpine_crossing', -39.074, 175.664],
  ['tongariro_northern_circuit', -39.159, 175.689],
  ['tour_du_mont_blanc', 45.96, 6.886],
  ['tour_of_monte_rosa', 46.022, 7.747],
  ['trolltunga', 60.134, 6.757],
  ['vikos_gorge', 39.882, 20.75],
  ['walls_of_jerusalem', -41.785, 146.254],
  ['west_coast_trail', 48.579, -124.41],
  ['west_fork_oak_creek', 34.99, -111.745],
  ['west_highland_way', 55.956, -4.33],
  ['western_arthur_range_traverse', -43.038, 146.299],
  ['whitsunday_ngaro_sea_trail', -20.261, 148.835],
  ['wilderness_coast_walk', -37.559, 149.772],
  ['wilsons_promontory_southern_circuit', -39.033, 146.356],
  ['wonderland_trail', 46.87, -121.654],
  ['yosemite_valley_loop_trail', 37.74, -119.573],
  ['yuraygir_coastal_walk', -29.83, 153.287],
];

// Parse GPS coordinates from text input
// Supports: "-41.636, 145.949", "41.636S 145.949E", "41.636 S, 145.949 E"
export function parseCoordinates(input: string): { lat: number; lng: number } | null {
  const s = input.trim().replace(/,/g, ' ').replace(/\s+/g, ' ');

  // Try: number[N/S] number[E/W]
  const dirMatch = s.match(/^(-?\d+\.?\d*)\s*([NSns])[\s]*(-?\d+\.?\d*)\s*([EWew])$/);
  if (dirMatch) {
    let lat = parseFloat(dirMatch[1]);
    let lng = parseFloat(dirMatch[3]);
    if (dirMatch[2].toUpperCase() === 'S') lat = -lat;
    if (dirMatch[4].toUpperCase() === 'W') lng = -lng;
    if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) return { lat, lng };
  }

  // Try: two plain numbers (lat, lng)
  const numMatch = s.match(/^(-?\d+\.?\d*)\s+(-?\d+\.?\d*)$/);
  if (numMatch) {
    const lat = parseFloat(numMatch[1]);
    const lng = parseFloat(numMatch[2]);
    if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) return { lat, lng };
  }

  return null;
}

// Haversine distance in km
export function haversineKm(lat1: number, lng1: number, lat2: number, lng2: number): number {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLng / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

export function findClosestTrail(lat: number, lng: number, radiusKm = 50): string | null {
  let closest: { id: string; dist: number } | null = null;
  for (const [id, tLat, tLng] of trailheads) {
    const dist = haversineKm(lat, lng, tLat, tLng);
    if (dist <= radiusKm && (closest === null || dist < closest.dist)) {
      closest = { id, dist };
    }
  }
  return closest?.id ?? null;
}
