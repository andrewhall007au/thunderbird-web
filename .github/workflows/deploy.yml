name: Test and Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio stripe || true

      - name: Run tests
        run: |
          python -m pytest tests/ -v --tb=short -x --ignore=tests/e2e_sms

      - name: Test summary
        if: always()
        run: |
          echo "Tests completed"

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install scanning tools
        run: pip install bandit pip-audit

      - name: Run Bandit (Python SAST)
        run: bandit -r app/ -ll -f json -o bandit-report.json || true

      - name: Run pip-audit (dependency CVEs)
        run: pip-audit -r requirements.txt || true

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: backend/bandit-report.json
          retention-days: 30

  deploy:
    name: Deploy to Production
    needs: [test, security]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Build frontend on GitHub Actions
        run: |
          npm ci
          npm run build
        env:
          NEXT_PUBLIC_API_URL: ""

      - name: Deploy frontend source to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "app/*,public/*,package.json,package-lock.json,next.config.js,tailwind.config.js,postcss.config.js,tsconfig.json,middleware.ts"
          target: "/root/thunderbird-web"
          overwrite: true
          rm: false

      - name: Deploy built frontend to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: ".next/*"
          target: "/root/thunderbird-web"
          overwrite: true
          rm: false

      - name: Install production dependencies and restart frontend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /root/thunderbird-web
            npm install --production --prefer-offline
            systemctl restart thunderbird-web || true

      - name: Deploy backend to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "backend/*"
          target: "/root/thunderbird-web"
          strip_components: 0
          overwrite: true
          rm: false

      - name: Restart backend service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /root/thunderbird-web/backend
            echo "Clearing Python cache..."
            find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
            find . -name "*.pyc" -delete 2>/dev/null || true
            source venv/bin/activate
            pip install -r requirements.txt -q
            echo "Restarting backend service..."
            systemctl restart thunderbird-api
            sleep 5
            systemctl status thunderbird-api --no-pager
            echo "Testing analytics endpoint..."
            curl -i -X POST http://localhost:8000/api/analytics \
              -H "Content-Type: application/json" \
              -d '{"event":"deploy_test","variant":"A","entry_path":"organic"}' 2>&1 | grep -E "^HTTP|^content-type" || true

      - name: Update nginx configuration
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /root/thunderbird-web
            echo "Copying nginx config to BOTH sites-available and sites-enabled..."
            cp deploy/nginx_complete.conf /etc/nginx/sites-available/thunderbird
            cp deploy/nginx_complete.conf /etc/nginx/sites-enabled/thunderbird
            echo "Verifying CSP in sites-enabled (the one nginx actually uses)..."
            grep "worker-src\|openfreemap" /etc/nginx/sites-enabled/thunderbird || echo "CSP fix not in active config!"
            nginx -t
            echo "Restarting nginx..."
            systemctl restart nginx
            sleep 2
            echo "Checking live CSP header..."
            curl -sI https://thunderbird.bot | grep -i "content-security-policy"

      - name: Investigate nginx setup
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "=== NGINX INVESTIGATION ==="
            echo ""
            echo "1. Checking for multiple nginx processes:"
            ps aux | grep nginx | grep -v grep
            echo ""
            echo "2. Checking nginx config file being used:"
            nginx -T 2>&1 | grep -A2 "configuration file"
            echo ""
            echo "3. Checking all server blocks in loaded config:"
            nginx -T 2>&1 | grep -A3 "server_name thunderbird.bot"
            echo ""
            echo "4. Checking CSP header in ALL config locations:"
            echo "From sites-available:"
            grep -n "Content-Security-Policy" /etc/nginx/sites-available/thunderbird | head -2
            echo "From sites-enabled:"
            grep -n "Content-Security-Policy" /etc/nginx/sites-enabled/thunderbird | head -2
            echo ""
            echo "5. Checking if sites-available is symlinked to sites-enabled:"
            ls -la /etc/nginx/sites-enabled/thunderbird
            echo ""
            echo "6. Testing direct nginx response (bypassing any proxy):"
            curl -sI -H "Host: thunderbird.bot" http://127.0.0.1:443 2>&1 | grep -i "content-security\|curl:" || echo "Could not connect to local nginx"
            echo ""
            echo "7. Checking for any nginx config includes:"
            grep -r "add_header.*Content-Security-Policy" /etc/nginx/conf.d/ 2>/dev/null || echo "No CSP in conf.d"
            echo ""
            echo "8. Verifying nginx loaded config matches file:"
            echo "Config file CSP:"
            grep "Content-Security-Policy" /etc/nginx/sites-available/thunderbird | grep -o "connect-src[^;]*"
            echo "Loaded config CSP:"
            nginx -T 2>&1 | grep "Content-Security-Policy" | grep -o "connect-src[^;]*" | head -1

      - name: Run browser-based smoke tests against production
        run: |
          npm install
          npx playwright install chromium
          npx playwright test e2e/critical-flows.spec.ts --config=e2e/production.config.ts --project=chromium
        env:
          TEST_URL: https://thunderbird.bot

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: production-test-results
          path: test-results/
          retention-days: 30

      - name: Deployment complete
        run: |
          echo "✅ Deployment successful!"
          echo "✅ Production smoke tests passed!"
          echo "Server: ${{ secrets.SERVER_HOST }}"
